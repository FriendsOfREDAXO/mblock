<?php

// ðŸŽ¯ MBlock 4.0 - Cardgrid mit Tabs (erweitert) - MForm 8

use FriendsOfRedaxo\MForm;

// base ID
$id = 1;

// init mform mit moderner MForm 8 Syntax - Tab-Struktur fÃ¼r Cardgrid
$MBlock = MForm::factory()
->addTabElement('Cards', MForm::factory()
    ->addTextField("$id.0.header", array(
        'label' => 'Header:',
    ))
    ->addMediaField(1, array(
        'label' => '<i class="fa fa-file" aria-hidden="true"></i> Medium',
        'preview' => '1'
    ))
    ->addTextField("$id.0.imageTitle", array(
        'label' => 'Bildinfo:'
    ))
    ->addSelectField("$id.0.crop")
    ->setLabel('Bildzuschnitt:')
    ->setOptions(array(
        '' => 'ja',
        '2' => 'nein',
    ))
    ->addTextAreaField("$id.0.content", array(
        'label' => 'Inhalt:',
        'data-lang' => \Cke5\Utils\Cke5Lang::getUserLang() ,
        'data-profile' => 'default',
        'class' => 'cke5-editor'
    ))
    ->addCustomLinkField("$id.0.1",array('label'=>'Link'))
    ->addTextField("$id.0.LinkText", array(
        'label' => 'Linktext (optional):'
    ))
    // ðŸ†• MBlock 4.0 - Online/Offline Status (hidden field fÃ¼r Toggle-Funktion)
   ->addHiddenField("$id.0.mblock_offline", '0')
)
->addTabElement('Design', MForm::factory()
    ->addSelectField("$id.0.gkHeader")
    ->setLabel('Hintergrundfarbe Header:')
    ->setOptions(array(
        'default' => 'Default',
        'primary' => 'Primary',
        'secondary' => 'Secondary',
        'orange' => 'Orange',
        'green' => 'GrÃ¼n',
        'blue' => 'Blau',
        'brown' => 'Braun',
        'red' => 'Rot',
        'turquoise' => 'TÃ¼rkis',
        'yellow' => 'Gelb',
        'dark' => 'Dunkel',
        'light' => 'Hell'
    ))
    ->addSelectField("$id.0.image_aspect")
    ->setLabel('Bild Aspect Ratio:')
    ->setOptions(array(
        '1x1' => '1:1 (Quadrat)',
        '4x3' => '4:3 (Standard)',
        '16x9' => '16:9 (Widescreen)',
        '3x2' => '3:2 (Foto)',
        '2x3' => '2:3 (Hochformat)',
        '21x9' => '21:9 (Ultrawide)'
    ))
    ->addSelectField("$id.0.colWidth")
    ->setLabel('Card Breite:')
    ->setOptions(array(
        'col-12 col-md-6 col-lg-4' => '3 Spalten (Standard)',
        'col-12 col-md-6' => '2 Spalten',
        'col-12 col-md-6 col-lg-3' => '4 Spalten',
        'col-12' => '1 Spalte (Full Width)'
    ))
);

// ðŸ†• MBlock 4.0 - erweiterte Konfiguration mit Copy & Paste (automatisch aktiviert)
echo MBlock::show($id, $MBlock, array(
    'max' => 24,          // Maximum Anzahl Items
    'min' => 1,           // Minimum Anzahl Items  
    'category' => array(
        'Cards',          // Tab 1 - Inhalte
        'Design'          // Tab 2 - Design Optionen
    ),
    'sortable' => true,   // Items sortierbar
    'settings' => array(
        'mediapool_token_check' => false, // Token-Check fÃ¼r Media-IDs 1-10
    )
));

?>

<!-- ============================================ -->
<!-- ðŸ“± MODUL-AUSGABE -->
<!-- ============================================ -->

<?php

// ðŸŽ¯ MBlock 4.0 - Cardgrid mit Tabs (erweitert) - Ausgabe

$cards = rex_var::toArray("REX_MBLOCK[1]");

if (count($cards) > 0):
?>
<section class="cardgrid-section">
    <div class="container-fluid">
        <div class="row g-4">
            <?php
            foreach ($cards as $item):
                // MBlock 4.0 - Online/Offline Check via hidden field
                if (!empty($item['mblock_offline']) && $item['mblock_offline'] == '1') {
                    continue; // Skip offline items
                }
                
                // Variablen fÃ¼r bessere Lesbarkeit
                $header = htmlspecialchars($item['header'] ?? '');
                $media_id = (int)($item[1] ?? 0);
                $image_title = htmlspecialchars($item['imageTitle'] ?? '');
                $content = $item['content'] ?? '';
                $link_data = $item[1] ?? '';
                $link_text = htmlspecialchars($item['LinkText'] ?? 'Mehr erfahren');
                $bg_color = $item['gkHeader'] ?? 'default';
                $aspect_ratio = $item['image_aspect'] ?? '4x3';
                $col_width = $item['colWidth'] ?? 'col-12 col-md-6 col-lg-4';
                
                // Media-ID Validierung (REDAXO erlaubt nur 1-10)
                if ($media_id > 0 && $media_id <= 10) {
                    $media = rex_media::get($media_id);
                    $image_url = $media ? rex_url::media($media->getFileName()) : '';
                } else {
                    $image_url = '';
                }
                
                // Link verarbeiten
                $link_url = '';
                $link_target = '';
                if (!empty($link_data)) {
                    if (is_string($link_data) && strpos($link_data, '|') !== false) {
                        list($link_id, $link_name, $link_target) = explode('|', $link_data);
                        if ($link_id) {
                            $link_url = rex_getUrl($link_id);
                        }
                    }
                }
            ?>
            <div class="<?= $col_width ?>">
                <div class="card h-100 shadow-sm">
                    <?php if ($image_url): ?>
                    <div class="card-img-container aspect-ratio-<?= $aspect_ratio ?>">
                        <img src="<?= $image_url ?>" 
                             class="card-img-top" 
                             alt="<?= $image_title ?>"
                             loading="lazy">
                    </div>
                    <?php endif; ?>
                    
                    <?php if ($header): ?>
                    <div class="card-header bg-<?= $bg_color ?>">
                        <h5 class="card-title mb-0"><?= $header ?></h5>
                    </div>
                    <?php endif; ?>
                    
                    <div class="card-body">
                        <?php if ($content): ?>
                        <div class="card-text">
                            <?= $content ?>
                        </div>
                        <?php endif; ?>
                    </div>
                    
                    <?php if ($link_url): ?>
                    <div class="card-footer bg-transparent border-top-0">
                        <a href="<?= $link_url ?>" 
                           class="btn btn-primary btn-sm"
                           <?= $link_target ? 'target="' . $link_target . '"' : '' ?>>
                            <?= $link_text ?> <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
</section>

<style>
/* ðŸŽ¨ MBlock 4.0 - Cardgrid Styling mit Dark Mode Support */
.cardgrid-section {
    padding: 2rem 0;
}

.card-img-container {
    position: relative;
    overflow: hidden;
}

.card-img-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.card:hover .card-img-container img {
    transform: scale(1.05);
}

/* Aspect Ratios */
.aspect-ratio-1x1 {
    aspect-ratio: 1 / 1;
}

.aspect-ratio-4x3 {
    aspect-ratio: 4 / 3;
}

.aspect-ratio-16x9 {
    aspect-ratio: 16 / 9;
}

.aspect-ratio-3x2 {
    aspect-ratio: 3 / 2;
}

.aspect-ratio-2x3 {
    aspect-ratio: 2 / 3;
}

.aspect-ratio-21x9 {
    aspect-ratio: 21 / 9;
}

/* Dark Mode Support - Multi-Selector */
.rex-theme-dark .card,
[data-bs-theme="dark"] .card,
@media (prefers-color-scheme: dark) {
    .card {
        background-color: var(--bs-dark);
        border-color: var(--bs-gray-700);
        color: var(--bs-light);
    }
    
    .card-header {
        border-bottom-color: var(--bs-gray-700);
    }
    
    .card-footer {
        border-top-color: var(--bs-gray-700);
    }
}

/* Responsive Anpassungen */
@media (max-width: 768px) {
    .cardgrid-section {
        padding: 1rem 0;
    }
    
    .card-body {
        padding: 1rem 0.75rem;
    }
}
</style>

<?php endif; ?>
    ))
    ,true,false
)
->addTabElement('Settings fÃ¼r diese Card', MForm::factory()
    ->addSelectField("$id.0.ukWidth")
    ->setLabel('Breite:')
    ->setAttribute('class', 'mo')
    ->setOptions(array(
        'auto@m' => 'automatisch',
        '1-1@m' => '100%',
        '2-3@m' => '66%',
        '1-2@m' => '50%',
        '1-3@m' => '33%',
        '1-4@m' => '25%',
        '1-5@m' => '20%',
        'expand@m' => 'Ausdehnen'
    ))
    ->addSelectField("$id.0.linkdiv")
    ->setLabel('Kachel verlinken')
    ->setAttribute('class', 'selectpicker')
    ->setOptions(array(
        '' => 'Nein',
        'linkdiv' => 'ja'
    ))
    ->addSelectField("$id.0.ukColor")
    ->setLabel('Farbe:')
    ->setAttribute('class', 'selectpicker')
    ->setOptions(array(
        'default' => 'Standard',
        'primary' => 'Hauptfarbe',
        'secondary' => 'SekundÃ¤r',
        'muted' => 'Muted',
        'transparent' => 'Transparent',
        'transparent uk-light' => 'Transparent helle Schrift'
    ))
);

$mm = MBlock::show($id, $MBlock->show() , array(
    'max' => 100
));

// settings
$MForm = MForm::factory()
->addTabElement('Cards', MForm::factory()
    ->addHTML($mm), true, false)
->addTabElement('Sektionseinstellung', MForm::factory()
    ->addSelectField("2.0.gutterWidth")
    ->setLabel('Abstand:')
    ->setAttribute('class', 'selectpicker')
    ->setOptions(array(
        'medium' => 'normal',
        'small' => 'eng',
        'large' => 'weit',
        'collapse' => 'entfernen'
    ))
    ->addDescription("AbstÃ¤nde zwischen den 'Cards' verÃ¤ndern")
    ->addMediaField(1, array('label'=>'Hintergrundbild'))
    ->addSelectField("3.0.ukcolor")
    ->setLabel('Farbe:')
    ->setAttribute('class', 'selectpicker')
    ->setOptions(array(
        'default' => 'Standard',
        'primary' => 'PrimÃ¤r',
        'secondary' => 'SekundÃ¤r',
        'muted' => 'Muted',
    ))
    ->addCheckboxField("2.0.matchHeight", array(
        1 => 'Ja'
    ) , array(
        'label' => 'Alle gleiche HÃ¶he:'
    ))
    ->addSelectField(14, array(''=>'Standard',' uk-padding-remove'=>'Keine',' uk-padding-small'=>'mittel',' uk-padding-large'=>'groÃŸ'), array('label'=>'AbschnitssfÃ¼llung', 'class'=>'selectpicker'))
);

echo $MForm->show();
```

### Modul-Ausgabe - Verschiedene Auslese-MÃ¶glichkeiten

```php
<?php

// ===== VARIANTE 1: Neue zentrale getDataArray() Methode (empfohlen) =====

// Alle Daten abrufen
$allItems = MBlock::getDataArray("REX_VALUE[1]");
echo '<h3>Alle Items (getDataArray):</h3>';
dump($allItems);

// Nur Online-BlÃ¶cke fÃ¼r Frontend
$onlineItems = MBlock::getDataArray("REX_VALUE[1]", 'online');
echo '<h3>Nur Online Items:</h3>';
dump($onlineItems);

// Nur Offline-BlÃ¶cke fÃ¼r Backend-Previews
$offlineItems = MBlock::getDataArray("REX_VALUE[1]", 'offline');
echo '<h3>Nur Offline Items:</h3>';
dump($offlineItems);

// ===== VARIANTE 2: Convenience-Methoden =====

// Direkte Methoden fÃ¼r Online/Offline
$onlineItems2 = MBlock::getOnlineDataArray("REX_VALUE[1]");
$offlineItems2 = MBlock::getOfflineDataArray("REX_VALUE[1]");

echo '<h3>Online Items (Convenience-Methode):</h3>';
dump($onlineItems2);

// ===== VARIANTE 3: Legacy Array-Filterung =====

// Falls Array bereits vorhanden (Legacy)
$data = rex_var::toArray("REX_VALUE[1]");
$onlineItemsLegacy = MBlock::getOnlineItems($data);
$offlineItemsLegacy = MBlock::getOfflineItems($data);

echo '<h3>Legacy Methode - Online Items:</h3>';
dump($onlineItemsLegacy);

// ===== VARIANTE 4: Frontend-Ausgabe Beispiel =====

echo '<div class="uk-grid" data-uk-grid>';
foreach($onlineItems as $item) {
    $width = !empty($item['ukWidth']) ? $item['ukWidth'] : '1-3@m';
    $color = !empty($item['ukColor']) ? $item['ukColor'] : 'default';
    $linkdiv = !empty($item['linkdiv']) ? 'linkdiv' : '';
    
    echo '<div class="uk-width-'.$width.'">';
    echo '<div class="uk-card uk-card-'.$color.' '.$linkdiv.'">';
    
    // Header
    if(!empty($item['header'])) {
        echo '<div class="uk-card-header">';
        echo '<h3 class="uk-card-title">'.rex_escape($item['header']).'</h3>';
        echo '</div>';
    }
    
    // Media
    if(!empty($item['REX_MEDIA_1'])) {
        echo '<div class="uk-card-media-top">';
        echo '<img src="'.rex_url::media($item['REX_MEDIA_1']).'" alt="'.rex_escape($item['imageTitle']).'">';
        echo '</div>';
    }
    
    // Body
    if(!empty($item['content'])) {
        echo '<div class="uk-card-body">';
        echo $item['content']; // CKE5 Content
        echo '</div>';
    }
    
    // Footer mit Link
    if(!empty($item['1']) || !empty($item['LinkText'])) {
        echo '<div class="uk-card-footer">';
        $linkText = !empty($item['LinkText']) ? $item['LinkText'] : 'Weiterlesen';
        echo '<a href="'.$item['1'].'" class="uk-button uk-button-text">'.$linkText.'</a>';
        echo '</div>';
    }
    
    echo '</div>';
    echo '</div>';
}
echo '</div>';

// ===== VARIANTE 5: JSON-Ausgabe fÃ¼r JavaScript =====

echo '<script>';
echo 'var mblockData = '.json_encode($onlineItems).';';
echo 'console.log("MBlock Online Data:", mblockData);';
echo '</script>';

// ===== VARIANTE 6: Statistiken =====

$sectionSettings = rex_var::toArray("REX_VALUE[2]"); // Sektionseinstellungen
$backgroundMedia = "REX_MEDIA[1]"; // Hintergrundbild

echo '<h3>Statistiken:</h3>';
echo '<ul>';
echo '<li>Anzahl Online Cards: '.count($onlineItems).'</li>';
echo '<li>Anzahl Offline Cards: '.count($offlineItems).'</li>';
echo '<li>Gesamt Cards: '.count($allItems).'</li>';
echo '<li>Gutter Width: '.($sectionSettings[0]['gutterWidth'] ?? 'medium').'</li>';
echo '<li>Match Height: '.(!empty($sectionSettings[0]['matchHeight']) ? 'Ja' : 'Nein').'</li>';
if(!empty($backgroundMedia)) {
    echo '<li>Hintergrundbild: '.$backgroundMedia.'</li>';
}
echo '</ul>';
```
