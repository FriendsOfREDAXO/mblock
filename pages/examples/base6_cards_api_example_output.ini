<?php

use FriendsOfRedaxo\MBlock\MBlock;

// Nur Online-Items laden
$items = MBlock::getOnlineDataArray("REX_VALUE[1]");

// Nach Priorität sortieren (hoch zuerst)
$sortedItems = MBlock::sortByField($items, 'priority', 'ASC', 'numeric');

// Nach Kategorie gruppieren
$groupedItems = MBlock::groupByField($sortedItems, 'category');

// Ausgabe pro Kategorie
foreach ($groupedItems as $category => $categoryItems) {
    echo '<div class="category-section">';
    echo '<h2 class="category-title">' . rex_escape($category) . ' (' . count($categoryItems) . ' Items)</h2>';
    
    // Nur die ersten 5 Items pro Kategorie anzeigen
    $limitedItems = MBlock::limitItems($categoryItems, 5);
    
    echo '<div class="cards-grid row">';
    foreach ($limitedItems as $item) {
        // Daten extrahieren
        $title = rex_escape($item['title'] ?? '');
        $teaser = rex_escape($item['teaser'] ?? '');
        $date = rex_escape($item['date'] ?? '');
        $priority = $item['priority'] ?? '2';
        $mediaId = $item['REX_MEDIA_21'] ?? ''; // Media-ID 21!
        
        // Priority CSS-Klasse
        $priorityClass = $priority == '1' ? 'priority-high' : ($priority == '3' ? 'priority-low' : 'priority-normal');
        
        echo '<div class="col-md-4 mb-3">';
        echo '<div class="card ' . $priorityClass . '">';
        
        // Bild
        if ($mediaId) {
            $media = rex_media::get($mediaId);
            if ($media) {
                echo '<img src="' . rex_media_manager::getUrl('rex_media_medium', $media->getFileName()) . '" 
                           alt="' . rex_escape($media->getTitle()) . '" class="card-img-top" />';
            }
        }
        
        echo '<div class="card-body">';
        
        // Titel
        if ($title) {
            echo '<h5 class="card-title">' . $title . '</h5>';
        }
        
        // Teaser
        if ($teaser) {
            echo '<p class="card-text">' . $teaser . '</p>';
        }
        
        // Datum
        if ($date) {
            echo '<small class="text-muted">Datum: ' . $date . '</small>';
        }
        
        echo '</div>'; // card-body
        echo '</div>'; // card
        echo '</div>'; // col
    }
    echo '</div>'; // cards-grid
    echo '</div>'; // category-section
}

// 🎯 Erweiterte Filterung - Beispiele
echo '<hr><h3>🎯 Filterbeispiele:</h3>';

// Nur News-Items
$newsItems = MBlock::filterByField($items, 'category', 'news');
echo '<p><strong>News Items:</strong> ' . count($newsItems) . '</p>';

// Nur hohe Priorität
$highPriorityItems = MBlock::filterByField($items, 'priority', '1');
echo '<p><strong>Hohe Priorität:</strong> ' . count($highPriorityItems) . '</p>';

// Nach Datum sortiert (neueste zuerst)
$sortedByDate = MBlock::sortByField($items, 'date', 'DESC', 'date');
$latestItems = MBlock::limitItems($sortedByDate, 3);
echo '<p><strong>Neueste 3 Items:</strong></p>';
foreach ($latestItems as $item) {
    echo '<li>' . rex_escape($item['title'] ?? 'Kein Titel') . ' (' . rex_escape($item['date'] ?? 'Kein Datum') . ')</li>';
}

// 🔍 SEO Schema.org JSON-LD generieren
$schema = MBlock::generateSchema($items, 'Article', [
    'headline' => 'title',
    'description' => 'teaser',
    'datePublished' => 'date',
    'image' => 'REX_MEDIA_21'
]);

echo '<script type="application/ld+json">' . json_encode($schema) . '</script>';

// 📊 Statistiken
echo '<hr><h3>📊 Statistiken:</h3>';
echo '<ul>';
echo '<li>Gesamt Items: ' . count($items) . '</li>';
echo '<li>Kategorien: ' . count($groupedItems) . '</li>';
echo '<li>Mit Bild: ' . count(array_filter($items, function($item) { return !empty($item['REX_MEDIA_21']); })) . '</li>';
echo '</ul>';

?>
