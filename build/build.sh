#!/bin/bash

#
# MBlock JavaScript Build Script
# 
# Automatisierte Minification fÃ¼r mblock.js
# Erstellt mblock.min.js fÃ¼r Produktionseinsatz
#
# Usage: ./build.sh
#
# @author MBlock Development Team
# @version 1.0.0
#

set -e  # Exit on any error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "ğŸš€ MBlock Build Process gestartet"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js ist nicht installiert!"
    echo "ğŸ’¡ Installiere Node.js von: https://nodejs.org/"
    exit 1
fi

echo "âœ… Node.js gefunden: $(node --version)"

# Check if package.json exists
if [ ! -f "package.json" ]; then
    echo "âŒ package.json nicht gefunden!"
    exit 1
fi

# Install dependencies if node_modules doesn't exist
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installiere Dependencies..."
    npm install
    echo "âœ… Dependencies installiert"
else
    echo "âœ… Dependencies bereits vorhanden"
fi

# Check if source file exists
SOURCE_FILE="../assets/mblock.js"
if [ ! -f "$SOURCE_FILE" ]; then
    echo "âŒ Quelldatei nicht gefunden: $SOURCE_FILE"
    exit 1
fi

echo "ğŸ“– Quelldatei gefunden: $SOURCE_FILE"

# Run minification
# ğŸ”§ Create combined modular file first
echo "ğŸ”— Erstelle kombinierte Datei aus modularen Komponenten..."
COMBINED_FILE="../assets/mblock-combined.js"
CORE_FILE="../assets/mblock-core.js"
MANAGEMENT_FILE="../assets/mblock-management.js"
FEATURES_FILE="../assets/mblock-features.js"

# Check if modular files exist
if [ ! -f "$CORE_FILE" ] || [ ! -f "$MANAGEMENT_FILE" ] || [ ! -f "$FEATURES_FILE" ]; then
    echo "âŒ Modulare Dateien nicht vollstÃ¤ndig vorhanden!"
    echo "   BenÃ¶tigt: mblock-core.js, mblock-management.js, mblock-features.js"
    exit 1
fi

# Combine modular files with proper headers
{
    echo "/**"
    echo " * MBlock Combined - Generated from modular sources"
    echo " * "
    echo " * Build Date: $(date)"
    echo " * Source Files: mblock-core.js + mblock-management.js + mblock-features.js"
    echo " * "
    echo " * This file is automatically generated. Do not edit manually!"
    echo " * Edit the individual modular files instead."
    echo " */"
    echo ""
    
    echo "// ==================== MBLOCK CORE MODULE ===================="
    cat "$CORE_FILE"
    echo ""
    echo ""
    
    echo "// ================== MBLOCK MANAGEMENT MODULE ================"
    cat "$MANAGEMENT_FILE"
    echo ""
    echo ""
    
    echo "// ================== MBLOCK FEATURES MODULE =================="
    cat "$FEATURES_FILE"
    
} > "$COMBINED_FILE"

echo "âœ… Kombinierte Datei erstellt: mblock-combined.js"

# Also create/update mblock.js for development use
echo "ğŸ”— Aktualisiere mblock.js fÃ¼r Entwicklungsmodus..."
cp "$COMBINED_FILE" "../assets/mblock.js"
echo "âœ… mblock.js aktualisiert"

echo "âš™ï¸  Starte Minification der kombinierten Datei..."
# Update minify.js to use the combined file
export MBLOCK_SOURCE_FILE="$COMBINED_FILE"
node minify.js

# Verify output
OUTPUT_FILE="../assets/mblock.min.js"
if [ -f "$OUTPUT_FILE" ]; then
    echo "âœ… Build erfolgreich abgeschlossen!"
    echo ""
    echo "ğŸ“ Output Dateien:"
    ls -la "$OUTPUT_FILE"* 2>/dev/null || true
    echo ""
    echo "ğŸ¯ NÃ¤chste Schritte:"
    echo "   1. Teste mblock.min.js in deiner REDAXO-Installation"
    echo "   2. Update boot.php um mblock.min.js zu verwenden"
    echo "   3. Deploye in die Produktion"
else
    echo "âŒ Build fehlgeschlagen - Output Datei nicht erstellt"
    exit 1
fi

echo ""
echo "ğŸ‰ MBlock Build Process abgeschlossen!"
