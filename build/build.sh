#!/bin/bash

#
# MBlock JavaScript Build Script
# 
# Automatisierte Minification für mblock.js
# Erstellt mblock.min.js für Produktionseinsatz
#
# Usage: ./build.sh
#
# @author MBlock Development Team
# @version 1.0.0
#

set -e  # Exit on any error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "🚀 MBlock Build Process gestartet"
echo "═══════════════════════════════════"

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "❌ Node.js ist nicht installiert!"
    echo "💡 Installiere Node.js von: https://nodejs.org/"
    exit 1
fi

echo "✅ Node.js gefunden: $(node --version)"

# Check if package.json exists
if [ ! -f "package.json" ]; then
    echo "❌ package.json nicht gefunden!"
    exit 1
fi

# Install dependencies if node_modules doesn't exist
if [ ! -d "node_modules" ]; then
    echo "📦 Installiere Dependencies..."
    npm install
    echo "✅ Dependencies installiert"
else
    echo "✅ Dependencies bereits vorhanden"
fi

# Check if source file exists
SOURCE_FILE="../assets/mblock.js"
if [ ! -f "$SOURCE_FILE" ]; then
    echo "❌ Quelldatei nicht gefunden: $SOURCE_FILE"
    exit 1
fi

echo "📖 Quelldatei gefunden: $SOURCE_FILE"

# Run minification
# 🔧 Create combined modular file first
echo "🔗 Erstelle kombinierte Datei aus modularen Komponenten..."
COMBINED_FILE="../assets/mblock-combined.js"
CORE_FILE="../assets/mblock-core.js"
MANAGEMENT_FILE="../assets/mblock-management.js"
FEATURES_FILE="../assets/mblock-features.js"

# Check if modular files exist
if [ ! -f "$CORE_FILE" ] || [ ! -f "$MANAGEMENT_FILE" ] || [ ! -f "$FEATURES_FILE" ]; then
    echo "❌ Modulare Dateien nicht vollständig vorhanden!"
    echo "   Benötigt: mblock-core.js, mblock-management.js, mblock-features.js"
    exit 1
fi

# Combine modular files with proper headers
{
    echo "/**"
    echo " * MBlock Combined - Generated from modular sources"
    echo " * "
    echo " * Build Date: $(date)"
    echo " * Source Files: mblock-core.js + mblock-management.js + mblock-features.js"
    echo " * "
    echo " * This file is automatically generated. Do not edit manually!"
    echo " * Edit the individual modular files instead."
    echo " */"
    echo ""
    
    echo "// ==================== MBLOCK CORE MODULE ===================="
    cat "$CORE_FILE"
    echo ""
    echo ""
    
    echo "// ================== MBLOCK MANAGEMENT MODULE ================"
    cat "$MANAGEMENT_FILE"
    echo ""
    echo ""
    
    echo "// ================== MBLOCK FEATURES MODULE =================="
    cat "$FEATURES_FILE"
    
} > "$COMBINED_FILE"

echo "✅ Kombinierte Datei erstellt: mblock-combined.js"

# Also create/update mblock.js for development use
echo "🔗 Aktualisiere mblock.js für Entwicklungsmodus..."
cp "$COMBINED_FILE" "../assets/mblock.js"
echo "✅ mblock.js aktualisiert"

echo "⚙️  Starte Minification der kombinierten Datei..."
# Update minify.js to use the combined file
export MBLOCK_SOURCE_FILE="$COMBINED_FILE"
node minify.js

# Verify output
OUTPUT_FILE="../assets/mblock.min.js"
if [ -f "$OUTPUT_FILE" ]; then
    echo "✅ Build erfolgreich abgeschlossen!"
    echo ""
    echo "📁 Output Dateien:"
    ls -la "$OUTPUT_FILE"* 2>/dev/null || true
    echo ""
    echo "🎯 Nächste Schritte:"
    echo "   1. Teste mblock.min.js in deiner REDAXO-Installation"
    echo "   2. Update boot.php um mblock.min.js zu verwenden"
    echo "   3. Deploye in die Produktion"
else
    echo "❌ Build fehlgeschlagen - Output Datei nicht erstellt"
    exit 1
fi

echo ""
echo "🎉 MBlock Build Process abgeschlossen!"
