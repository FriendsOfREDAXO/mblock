let mblock=".mblock_wrapper";const MBlockUtils={selectors:{wrapper:".mblock_wrapper",sortitem:"> div.sortitem",addme:".addme",removeme:".removeme",moveup:".moveup",movedown:".movedown",copyBtn:".mblock-copy-btn",pasteBtn:".mblock-paste-btn",onlineToggle:".mblock-online-toggle",autoToggle:".mblock-offline-toggle-btn"},dom:{findElement:(e,t)=>e?.find?e.find(t):$(t),safeRemove:e=>!!e?.length&&(e.find("*").off(".mblock"),e.off(".mblock"),e.remove(),!0),createFromHTML:e=>$($.parseHTML(e))},events:{bindSafe(e,t,o,n=".mblock"){e?.length&&e.off(t+n).on(t+n,o)},cleanup(e,t=".mblock"){mblock_validate_element(e)&&e.jquery&&(e.find("*").off(t),e.off(t))}},state:{isDisabled:e=>e.prop("disabled")||e.hasClass("disabled"),toggleDisabled(e,t){e.prop("disabled",t),e.toggleClass("disabled",t)}},nested:{cleanupDuplicates(e){if(void 0!==MBlockAddonFixes)return MBlockAddonFixes.gridblock.cleanupDuplicates(e)},initializeNested(e){if(void 0!==MBlockAddonFixes)return MBlockAddonFixes.gridblock.initializeNested(e)}},animation:{addGlowEffect(e,t="mblock-copy-glow",o=1e3){e?.length&&(e.addClass(t),setTimeout(()=>e.removeClass(t),o))},flashEffect(e,t="mblock-dropped-flash",o=600){e?.length&&(e.addClass(t),setTimeout(()=>e.removeClass(t),o))}},is:{validElement:e=>mblock_validate_element(e),rexField:(e,t)=>e&&e.indexOf(`REX_${t}_`)>=0,hiddenInput:e=>"hidden"===e.attr("type")}};function mblock_show_message(e,t="warning",o=5e3){if("undefined"!=typeof BLOECKS&&BLOECKS.fireMBlockToast)BLOECKS.fireMBlockToast(e,t,o);else if("undefined"!=typeof BLOECKS&&BLOECKS.showToast)BLOECKS.showToast(e,t,o);else{if(void 0!==MBLOCK_TOAST&&MBLOCK_TOAST.show)return void MBLOCK_TOAST.show(e,t,o);"error"===t||"danger"===t?console.error("MBlock:",e):console.warn("MBlock:",e)}}const MBLOCK_TOAST=function(){let e=0,t=null;return{show:function(o,n="info",l=4e3){try{const i=t||(t=document.createElement("div"),t.className="mblock-toast-container",t.style.position="fixed",t.style.top="20px",t.style.right="20px",t.style.zIndex=99999,t.style.display="flex",t.style.flexDirection="column",t.style.gap="8px",document.body.appendChild(t),t),c="mblock-toast-"+ ++e,r=document.createElement("div");return r.id=c,r.className="mblock-toast mblock-toast-"+n,r.style.minWidth="180px",r.style.maxWidth="420px",r.style.padding="10px 14px",r.style.borderRadius="4px",r.style.boxShadow="0 2px 8px rgba(0,0,0,0.12)",r.style.background="error"===n||"danger"===n?"#f8d7da":"success"===n?"#d4edda":"#fff3cd",r.style.color="#222",r.style.border="1px solid rgba(0,0,0,0.06)",r.style.fontSize="13px",r.innerText=o,i.appendChild(r),setTimeout(()=>{try{r.style.opacity="0",r.style.transition="opacity 250ms ease"}catch(e){}},Math.max(50,l-250)),setTimeout(()=>{try{r.parentNode&&r.parentNode.removeChild(r)}catch(e){}},l+100),c}catch(e){return console.warn("MBlock: Toast fallback failed",e),!1}}}}();function mblock_get_text(e,t=""){if("undefined"!=typeof rex&&rex.mblock_i18n&&rex.mblock_i18n[e.replace("mblock_toast_","")])return rex.mblock_i18n[e.replace("mblock_toast_","")];if("undefined"!=typeof rex&&rex.i18n){const o=rex.i18n.msg(e);return o!==e?o:t}const o=(navigator.language||"de").substring(0,2),n={mblock_toast_copy_success:{de:"Block erfolgreich kopiert!",en:"Block copied successfully!",es:"¡Bloque copiado con éxito!",pt:"Bloco copiado com sucesso!",sv:"Block kopierat framgångsrikt!",nl:"Blok succesvol gekopieerd!"},mblock_toast_paste_success:{de:"Block erfolgreich eingefügt!",en:"Block pasted successfully!",es:"¡Bloque pegado con éxito!",pt:"Bloco colado com sucesso!",sv:"Block inklistrat framgångsrikt!",nl:"Blok succesvol geplakt!"},mblock_toast_clipboard_empty:{de:"Keine Daten in der Zwischenablage",en:"No data in clipboard",es:"No hay datos en el portapapeles",pt:"Nenhum dado na área de transferência",sv:"Inga data i urklipp",nl:"Geen gegevens in klembord"},mblock_toast_module_type_mismatch:{de:"Modultyp stimmt nicht überein",en:"Module type mismatch",es:"No coincide el tipo de módulo",pt:"Tipo de módulo não corresponde",sv:"Modultyp matchar inte",nl:"Moduletype komt niet overeen"}}[e];return n&&n[o]?n[o]:n&&n.de?n.de:t}function mblock_validate_element(e){try{return!!e&&(e.jquery?e.length>0&&"function"==typeof e.data:!!e.nodeType||"string"==typeof e&&e.length>0)}catch(e){return console.error("MBlock: Error in element validation:",e),!1}}function mblock_cleanup_events(e,t=".mblock"){try{mblock_validate_element(e)&&e.jquery&&(e.find("*").off(t),e.off(t))}catch(e){console.error("MBlock: Error in event cleanup:",e)}}function checkCopyPasteEnabled(){try{const e=$(mblock).first();if(e.length){const t=e.attr("data-copy_paste");if(void 0!==t)return"1"===t||"true"===t||!0===t}const t=$(".mblock-copy-btn").length>0,o=$(".mblock-copy-paste-toolbar").length>0;return t||o}catch(e){return console.warn("MBlock: Error checking copy/paste configuration:",e),!0}}function mblock_smooth_scroll_to_element(e,t={}){if(!e)return;if("undefined"!=typeof BLOECKS&&"function"==typeof BLOECKS.scrollToSlice)try{return void BLOECKS.scrollToSlice(e)}catch(e){console.warn("MBlock: Bloecks scroll failed, using fallback:",e)}const o={behavior:"smooth",block:"center",inline:"nearest",offset:-20,...t};try{if("scrollIntoView"in e){const t=e.getBoundingClientRect().top+window.pageYOffset+o.offset;window.scrollTo({top:Math.max(0,t),behavior:o.behavior})}else e.scrollIntoView({behavior:o.behavior,block:o.block,inline:o.inline})}catch(t){try{e.scrollIntoView()}catch(e){console.warn("MBlock: Smooth scroll not available:",e)}}}"undefined"!=typeof module&&module.exports&&(module.exports={MBlockUtils:MBlockUtils,mblock_show_message:mblock_show_message,mblock_get_text:mblock_get_text,mblock_validate_element:mblock_validate_element});const MBlockWidgets={media:{captureData(e,t){e.find('input[id^="REX_MEDIA_"]').each(function(){const e=$(this),o=e.attr("id"),n=e.attr("name");if(o&&!o.includes("_NAME")&&"hidden"===e.attr("type")){const l=e.val(),i=o+"_NAME",c=$("#"+i);t[n]={type:"rex_media",value:l,hiddenId:o,displayId:i,displayValue:c.length?c.val():"",buttonOnclicks:{}};const r=e.closest(".input-group, .rex-js-widget-media");r.length&&r.find(".btn-popup").each(function(e){const o=$(this).attr("onclick");o&&(t[n].buttonOnclicks["btn_"+e]=o)})}})},restoreData(e,t,o){if(void 0!==t.value){o.val(t.value);const n=e.find("#"+t.displayId);if(n.length)t.displayValue&&n.val(t.displayValue);else{const n=o.attr("id");if(n){const o=e.find("#"+n+"_NAME");o.length&&t.displayValue&&o.val(t.displayValue)}}if(t.buttonOnclicks){const e=o.closest(".input-group, .rex-js-widget-media");e.length&&e.find(".btn-popup").each(function(e){const n=$(this),l="btn_"+e;if(t.buttonOnclicks[l]){let e=t.buttonOnclicks[l];const i=o.attr("id");if(i&&t.hiddenId!==i){e=e.replace(new RegExp(t.hiddenId,"g"),i);const o=t.hiddenId.replace("REX_MEDIA_",""),n=i.replace("REX_MEDIA_","");e=e.replace(new RegExp("'"+o+"'","g"),"'"+n+"'")}n.attr("onclick",e)}})}}},reinitialize(e,t=!1){e.find('input[id^="REX_MEDIA_"]').each(function(){const e=$(this),o=e.attr("id"),n=e.attr("name");if(o){console.log("MBlock: Reinitialisiere REX_MEDIA Widget:",o,"Name:",n);let l=e.closest(".rex-js-widget-media");if(l.length||(l=e.closest(".form-group, .col-sm-10, .input-group")),l.length){const n=l.find('.btn-popup, a[onclick*="REXMedia"], a[onclick*="openREXMedia"]');if(console.log("MBlock: Gefundene Media-Buttons:",n.length),n.each(function(){const e=$(this);let t=e.attr("onclick");if(t){console.log("MBlock: Original onclick:",t);const n=o.match(/REX_MEDIA_(\d+)/);if(n){const o=n[1];let l=t;t.includes("openREXMedia")?l=t.replace(/openREXMedia\([^,)]+/,`openREXMedia('${o}'`):t.includes("viewREXMedia")?l=t.replace(/viewREXMedia\([^,)]+/,`viewREXMedia('${o}'`):t.includes("deleteREXMedia")?l=t.replace(/deleteREXMedia\([^,)]+/,`deleteREXMedia('${o}'`):t.includes("addREXMedia")?l=t.replace(/addREXMedia\([^,)]+/,`addREXMedia('${o}'`):t.includes("openMedia")?l=t.replace(/openMedia\([^,)]+/,`openMedia('${o}'`):t.includes("deleteMedia")&&(l=t.replace(/deleteMedia\([^,)]+/,`deleteMedia('${o}'`)),l!==t&&(e.attr("onclick",l),console.log("MBlock: Aktualisiert onclick:",l))}}}),t){const t=l.find(".rex-media-preview, [data-media-id]");if(t.length){const o=e.val();o&&(t.attr("data-media-id",o),console.log("MBlock: GridBlock Media-Preview aktualisiert:",o))}}}else console.warn("MBlock: Kein Media-Widget-Container gefunden für:",o)}})}},link:{captureData(e,t){e.find('input[id^="REX_LINK_"]').each(function(){const e=$(this),o=e.attr("id"),n=e.attr("name");if(o&&!o.includes("_NAME")&&"hidden"===e.attr("type")){const l=e.val(),i=o+"_NAME",c=$("#"+i);t[n]={type:"rex_link",value:l,hiddenId:o,displayId:i,displayValue:c.length?c.val():"",buttonOnclicks:{}};const r=e.closest(".input-group");r.length&&r.find(".btn-popup").each(function(e){const o=$(this).attr("onclick");o&&(t[n].buttonOnclicks["btn_"+e]=o)})}})},restoreData(e,t,o){if(void 0!==t.value){o.val(t.value);const n=e.find("#"+t.displayId);if(n.length)t.displayValue?n.val(t.displayValue):t.value&&MBlockWidgets.link.fetchArticleName(t.value,n);else{const n=o.attr("id");if(n){const o=e.find("#"+n+"_NAME");o.length&&(t.displayValue?o.val(t.displayValue):t.value&&MBlockWidgets.link.fetchArticleName(t.value,o))}}if(t.buttonOnclicks){const e=o.closest(".input-group");e.length&&e.find(".btn-popup").each(function(e){const n=$(this),l="btn_"+e;if(t.buttonOnclicks[l]){let e=t.buttonOnclicks[l];const i=o.attr("id");if(i&&t.hiddenId!==i){e=e.replace(new RegExp(t.hiddenId,"g"),i);const o=t.hiddenId.replace("REX_LINK_",""),n=i.replace("REX_LINK_","");e=e.replace(new RegExp("'"+o+"'","g"),"'"+n+"'")}n.attr("onclick",e)}})}}},reinitialize(e,t=!1){e.find('input[id^="REX_LINK_"]').each(function(){const t=$(this),o=t.attr("id"),n=t.attr("name");if(o&&!o.includes("_NAME")&&"hidden"===t.attr("type")){console.log("MBlock: Reinitialisiere REX_LINK Widget:",o,"Name:",n);let l=t.closest(".rex-js-widget-link, .form-group, .input-group");if(l.length||(l=t.parent()),l.length){const n=l.find('.btn-popup, a[onclick*="REXLink"], a[onclick*="openLinkMap"]');console.log("MBlock: Gefundene Link-Buttons:",n.length),n.each(function(){const e=$(this);let t=e.attr("onclick");if(t){console.log("MBlock: Original Link onclick:",t);const n=o.match(/REX_LINK_(\d+)/);if(n){const l=n[1];let i=t;t.includes("openLinkMap")?i=t.replace(/openLinkMap\([^,)]+/,`openLinkMap('${o}'`):t.includes("deleteREXLink")?i=t.replace(/deleteREXLink\([^,)]+/,`deleteREXLink('${l}'`):t.includes("openLink")?i=t.replace(/openLink\([^,)]+/,`openLink('${o}'`):t.includes("deleteLink")&&(i=t.replace(/deleteLink\([^,)]+/,`deleteLink('${l}'`)),i!==t&&(e.attr("onclick",i),console.log("MBlock: Aktualisiert Link onclick:",i))}}});const i=o+"_NAME",c=e.find("#"+i),r=t.val();c.length&&r&&!c.val()&&(console.log("MBlock: Auto-populate Link display field for:",i),MBlockWidgets.link.fetchArticleName(r,c))}}})},fetchArticleName(e,t){if(!e||!t||!t.length)return;if(window.mblock_article_cache||(window.mblock_article_cache={}),window.mblock_article_cache[e])return t.val(window.mblock_article_cache[e]),void console.log("MBlock: Artikel-Name aus Cache:",window.mblock_article_cache[e],"für ID:",e);const o=$('input[name="clang"]').val()||1,n=rex.backend+"?page=structure/linkmap&opener_input_field=temp&article_id="+e+"&clang="+o;$.ajax({url:n,method:"GET",timeout:5e3,success:function(o){let n="";const l=[/<a[^>]+onclick="[^"]*selectLink[^"]*"[^>]*>([^<]+)</gi,/<span[^>]*class="[^"]*article[^"]*"[^>]*>([^<]+)</gi,/article_name['"]*:\s*['"]([^'"]+)['"]/gi,/"name"\s*:\s*"([^"]+)"/gi];for(const e of l){const t=e.exec(o);if(t&&t[1]&&t[1].trim()){n=t[1].trim();break}}n||(n="Artikel ["+e+"]"),window.mblock_article_cache[e]=n,t.val(n),t.trigger("change"),console.log("MBlock: Artikel-Name per AJAX geholt:",n,"für ID:",e)},error:function(){const o="Artikel ["+e+"]";window.mblock_article_cache[e]=o,t.val(o),console.log("MBlock: Artikel-Name Fallback verwendet:",o,"für ID:",e)}})}},selectpicker:{convertToPlain(e){try{e.find("select.selectpicker, .bootstrap-select select").each(function(){const e=$(this),t=e.val(),o=e.clone();o.removeClass("selectpicker bs-select-hidden"),o.removeAttr("data-live-search data-live-search-placeholder tabindex aria-describedby"),o.removeData(),o.css("display",""),o.addClass("mblock-needs-selectpicker"),o.val(t);const n=e.parents(".bootstrap-select");n.length>0?n.last().replaceWith(o):e.replaceWith(o)}),e.find(".bootstrap-select").each(function(){const e=$(this);e.find("select").length||e.remove()})}catch(e){console.error("MBlock: Error converting selectpicker to plain select:",e)}},initialize(e){if("function"==typeof $.fn.selectpicker){var t=e.find("select.mblock-needs-selectpicker");t.length&&(t.removeClass("mblock-needs-selectpicker").addClass("selectpicker"),t.selectpicker({noneSelectedText:"—"}),t.selectpicker("refresh"))}}},reinitializeAll(e){try{if(!e||!e.length)return!1;const t=parseInt(e.attr("data-mblock_index"))||1,o=(e.closest(".mblock_wrapper").find(".sortitem").length,MBlockAddonFixes.gridblock.isGridBlock(e));return console.log("MBlock: Widget-Reinitialisierung gestartet",{mblockIndex:t,isGridBlock:o,containerClass:e.attr("class")}),this.media.reinitialize(e,o),this.link.reinitialize(e,o),e.find('input[id^="REX_LINKLIST_"]').each(function(){const e=$(this),t=e.attr("id");if(t){console.log("MBlock: Reinitialisiere REX_LINKLIST Widget:",t);let o=e.closest(".rex-js-widget-linklist, .form-group");o.length||(o=e.parent()),o.length&&o.find('.btn-popup, a[onclick*="openLinklistMap"]').each(function(){const e=$(this);let o=e.attr("onclick");if(o&&o.includes("openLinklistMap")){const n=o.replace(/openLinklistMap\([^,)]+/,`openLinklistMap('${t}'`);n!==o&&(e.attr("onclick",n),console.log("MBlock: Aktualisiert Linklist onclick:",n))}})}}),o&&(console.log("MBlock: GridBlock erkannt - triggere rex:ready Event"),e.trigger("rex:ready",[e]),e.find("input, select, textarea").trigger("rex:ready"),"function"==typeof window.gridblock_reinit_widgets&&window.gridblock_reinit_widgets(e),setTimeout(()=>{this.selectpicker.initialize(e)},100)),setTimeout(()=>{e.trigger("rex:ready",[e]),e.find("input, select, textarea").trigger("change"),console.log("MBlock: Rex:ready events getriggert")},50),console.log("MBlock: REDAXO widgets erfolgreich reinitialisiert für",o?"GridBlock":"Standard MBlock"),!0}catch(e){return console.error("MBlock: Fehler bei der Reinitialisierung der REDAXO Widgets:",e),!1}}};$(document).ready(function(){setTimeout(function(){MBlockWidgets.link.initializeEmptyFields()},500),$(document).on("shown.bs.tab",function(e){setTimeout(function(){console.log("MBlock: Bootstrap Tab gewechselt - initialisiere REX_LINK-Felder..."),MBlockWidgets.link.initializeEmptyFields()},100)}),$(document).on("click",'.nav-tabs a, .nav-pills a, [data-toggle="tab"], [data-bs-toggle="tab"], .mform-tabs a',function(){setTimeout(function(){console.log("MBlock: Tab-Click erkannt - initialisiere REX_LINK-Felder..."),MBlockWidgets.link.initializeEmptyFields()},200)}),$(document).on("mform:tabChanged mform:tabShow",function(e){setTimeout(function(){console.log("MBlock: MForm Tab-Event - initialisiere REX_LINK-Felder..."),MBlockWidgets.link.initializeEmptyFields()},150)})}),MBlockWidgets.link.initializeEmptyFields=function(){try{console.log("MBlock: Initialisiere leere REX_LINK Display-Felder...");let e=0,t=0;$('input[id^="REX_LINK_"]').each(function(){const o=$(this),n=o.attr("id"),l=o.val();if(e++,console.log("MBlock: Prüfe REX_LINK Feld:",n,"Wert:",l,"Typ:",o.attr("type")),n&&!n.includes("_NAME")&&"hidden"===o.attr("type")&&l&&""!==l.trim()){const e=n+"_NAME",o=$("#"+e);if(console.log("MBlock: Suche Display-Feld:",e,"gefunden:",o.length,"aktueller Wert:",o.val()),o.length){const n=o.val()||"";""===n.trim()?(console.log("MBlock: Befülle leeres REX_LINK Display-Feld:",e,"für Artikel:",l),MBlockWidgets.link.fetchArticleName(l,o),t++):console.log("MBlock: Display-Feld bereits befüllt:",e,"Wert:",n)}else console.warn("MBlock: Display-Feld nicht gefunden:",e,"(möglicherweise in verstecktem Tab)")}}),console.log("MBlock: REX_LINK Initialisierung abgeschlossen. Gefunden:",e,"Verarbeitet:",t)}catch(e){console.error("MBlock: Fehler beim Initialisieren der REX_LINK Display-Felder:",e)}},window.mblock_reinitialize_redaxo_widgets=MBlockWidgets.reinitializeAll.bind(MBlockWidgets),window.mblock_fetch_article_name=MBlockWidgets.link.fetchArticleName.bind(MBlockWidgets.link),"undefined"!=typeof module&&module.exports&&(module.exports={MBlockWidgets:MBlockWidgets});const MBlockAddonFixes={gridblock:{cleanupDuplicates(e){try{if(!e||!e.length)return;e.find(".mblock_wrapper").each(function(){const e=$(this),t=e.find("> .mblock-single-add");t.length>1&&(console.log("MBlock: Removing duplicate single-add buttons"),t.slice(1).remove()),e.find("> .sortitem").length>0&&t.length>0&&(console.log("MBlock: Removing single-add button (sortitems exist)"),t.remove())})}catch(e){console.error("MBlock: Error cleaning up nested duplicates:",e)}},initializeNested(e){try{if(!e||!e.length)return;e.find(".mblock_wrapper").each(function(){const e=$(this);e.length&&(MBlockAddonFixes.gridblock.cleanupDuplicates(e.parent()),e.removeData("mblock_run"),console.log("MBlock: Safe initialization of nested wrapper"),mblock_init(e))})}catch(e){console.error("MBlock: Error initializing nested MBlocks:",e)}},isGridBlock:e=>!(!e||!e.length)&&(e.closest(".gridblock_wrapper").length>0||e.hasClass("gridblock-item"))},ckeditor:{destroyInstances(e){try{e.find(".cke5-editor").each(function(){const e=$(this),t=e.attr("id");if(t&&"undefined"!=typeof ckeditors&&ckeditors[t]){console.log("MBlock: Destroying CKEditor5 instance before reinit:",t);try{ckeditors[t].destroy(),delete ckeditors[t]}catch(e){console.warn("MBlock: Error destroying CKEditor5:",e)}}e.next(".ck-editor").remove(),e.show()})}catch(e){console.error("MBlock: Error destroying CKEditor5 instances:",e)}},captureContent(e,t){try{e.find(".cke5-editor, textarea[data-cke5-config]").each(function(){const e=$(this),o=e.attr("id"),n=e.attr("name");if(o&&n){console.log("MBlock Copy: Processing CKEditor5 field",n,{editorId:o,ckeditorsAvailable:"undefined"!=typeof ckeditors,ckeditorInstance:"undefined"!=typeof ckeditors&&ckeditors[o]?"found":"not found"});let l=e.val();if(o&&"undefined"!=typeof ckeditors&&ckeditors[o])try{const e=ckeditors[o].getData();e&&(l=e,console.log("MBlock Copy: Got CKEditor5 content:",l.substring(0,100)+"..."))}catch(e){console.warn("MBlock Copy: Failed to get CKEditor5 data, using textarea value:",e)}else if(window.CKEDITOR&&window.CKEDITOR.instances[o])try{const e=window.CKEDITOR.instances[o].getData();e&&(l=e,console.log("MBlock Copy: Got CKEditor4 content:",l.substring(0,100)+"..."))}catch(e){console.warn("MBlock Copy: Failed to get CKEditor4 data, using textarea value:",e)}t[n]={type:"ckeditor",value:l,config:{}},["cke5-config","cke5-toolbar","cke5-height","cke5-readonly"].forEach(o=>{const l=e.attr("data-"+o);l&&(t[n].config[o]=l)})}})}catch(e){console.error("MBlock: Error capturing CKEditor content:",e)}},restoreContent(e,t){try{Object.keys(t).forEach(o=>{const n=t[o];if(!n||"object"!=typeof n)return;if("ckeditor"!==n.type)return;let l=e.find(`[name="${o}"], [name="mblock_new_${o}"]`);if(!l.length||!n.value)return;console.log("MBlock Restore: Processing CKEditor field",o,"with content:",n.value.substring(0,100)+"..."),l.val(n.value);const i=l.attr("id");if(i){console.log("MBlock Restore: Setting up restoration for editor",i);const e=function(t=0){if(console.log("MBlock Restore: Attempt",t+1,"for editor",i),"undefined"!=typeof ckeditors&&ckeditors[i])try{return ckeditors[i].setData(n.value),void console.log("✅ MBlock Restore: CKEditor5 content restored for",i)}catch(e){console.warn("MBlock Restore: Failed to restore CKEditor5 content:",e)}else if(window.CKEDITOR&&window.CKEDITOR.instances[i])try{return window.CKEDITOR.instances[i].setData(n.value),void console.log("✅ MBlock Restore: CKEditor4 content restored for",i)}catch(e){console.warn("MBlock Restore: Failed to restore CKEditor4 content:",e)}t<15?setTimeout(()=>e(t+1),300):console.warn("❌ MBlock Restore: Timeout restoring content for",i,"after",15,"attempts")};setTimeout(()=>e(0),100)}})}catch(e){console.error("MBlock: Error restoring CKEditor content:",e)}}}};$(document).on("rex:ready",function(e,t){t.find(".cke5-editor[data-cke5-restore-content]").each(function(){const e=$(this),t=e.attr("id"),o=e.attr("data-cke5-restore-content");if(t&&o){console.log("MBlock: Attempting to restore CKEditor5 content for",t);const n=function(l=0){if(l>20)return console.warn("MBlock: Timeout restoring CKEditor5 content for",t),void e.removeAttr("data-cke5-restore-content");if("undefined"!=typeof ckeditors&&ckeditors[t])try{return ckeditors[t].setData(o),e.removeAttr("data-cke5-restore-content"),void console.log("MBlock: Successfully restored CKEditor5 content for",t)}catch(e){console.warn("MBlock: Error setting CKEditor5 data:",e)}setTimeout(()=>n(l+1),200)};setTimeout(()=>n(),300)}})}),"undefined"!=typeof module&&module.exports&&(module.exports={MBlockAddonFixes:MBlockAddonFixes});const MBlockSortable={destroy(e){try{const t=e?.get?e.get(0):e;if(t&&t._sortable)return"function"==typeof t._sortable.destroy&&t._sortable.destroy(),t._sortable=null,!0}catch(t){if(console.warn("MBlock: Sortable destroy error:",t),e?.get){const t=e.get(0);t&&(t._sortable=null)}}return!1},create(e){try{if(!e?.length||!e.get)return!1;const t=e.get(0);if(!document.contains(t)||"undefined"==typeof Sortable)return!1;const o=Sortable.create(t,{handle:".sorthandle",animation:150,ghostClass:"sortable-ghost",chosenClass:"mblock-sortable-chosen",dragClass:"mblock-dragging",onStart:e=>this._handleStart(e),onEnd:t=>this._handleEnd(t,e),onError:e=>console.error("MBlock: Sortable Error:",e)});return t._sortable=o,!0}catch(e){return console.error("MBlock: Error creating sortable instance:",e),!1}},reinitialize(e){this.destroy(e),setTimeout(()=>this.create(e),10)},_handleStart(e){try{document.body.classList.add("mblock-drag-active"),e.item&&e.item.classList.add("mblock-dragging")}catch(e){console.error("MBlock: Error in sortable onStart:",e)}},_handleEnd(e,t){try{document.body.classList.remove("mblock-drag-active"),e.item&&(e.item.classList.remove("mblock-dragging"),MBlockUtils.animation.flashEffect($(e.item))),mblock_reindex(t),mblock_remove(t);const o=$(e.item);o.length&&o.trigger("mblock:change",[o])}catch(e){console.error("MBlock: Error in sortable onEnd:",e)}}};function mblock_init(e){try{if(!e||!e.length||"function"!=typeof e.data)return console.warn("MBlock: Invalid element in mblock_init"),!1;if(e.data("mblock_run"))console.log("MBlock: Reinitializing existing MBlock wrapper - cleaning up first"),e.find(".mblock-single-add").remove();else{console.log("MBlock: Initializing new MBlock wrapper"),e.data("mblock_run",1),mblock_sort(e),mblock_set_unique_id(e,!1);const t=e.data("min"),o=e.data("max");1==t&&1==o&&e.addClass("hide_removeadded").addClass("hide_sorthandle")}return mblock_add_plus(e),mblock_init_toolbar(e),void 0!==MBlockOnlineToggle&&MBlockOnlineToggle.initializeStates(e),!0}catch(e){return console.error("MBlock: Error in mblock_init:",e),!1}}function mblock_init_sort(e){try{return!(!e||!e.length||(mblock_reindex(e),mblock_sort(e),0))}catch(e){return console.error("MBlock: Error in mblock_init_sort:",e),!1}}function mblock_sort(e){try{return!(!e||!e.length||(mblock_add(e),mblock_remove(e),mblock_sort_it(e),0))}catch(e){return console.error("MBlock: Error in mblock_sort:",e),!1}}function mblock_add_plus(e){const t=e.find("> div.sortitem").length>0,o=e.find("> div.mblock-single-add").length>0;t||o?t&&o&&(console.log("MBlock: Removing unnecessary single-add button (items exist)"),e.find("> div.mblock-single-add").remove()):(console.log("MBlock: Adding single-add button for empty wrapper"),e.prepend($($.parseHTML(e.data("mblock-single-add")))),e.find("> div.mblock-single-add .addme").unbind().bind("click",function(){mblock_add_item(e,!1),$(this).parents(".mblock-single-add").remove()}))}function mblock_remove(e){var t=e.find("> div.sortitem");1==t.length?(t.find(".removeme").prop("disabled",!0),t.find(".removeme").attr("data-disabled",!0)):(t.find(".removeme").prop("disabled",!1),t.find(".removeme").attr("data-disabled",!1)),e.data().hasOwnProperty("max")&&(t.length>=e.data("max")?e.find(".addme").prop("disabled",!0):e.find(".addme").prop("disabled",!1)),e.data().hasOwnProperty("min")&&(t.length<=e.data("min")?e.find(".removeme").prop("disabled",!0):e.find(".removeme").prop("disabled",!1)),t.each(function(o){o+1==e.data("min")&&t.length==e.data("min")&&$(this).find(".removeme").prop("disabled",!0),0==o?$(this).find(".moveup").prop("disabled",!0):$(this).find(".moveup").prop("disabled",!1),o+1==t.length?$(this).find(".movedown").prop("disabled",!0):$(this).find(".movedown").prop("disabled",!1)})}function mblock_sort_it(e){try{if(!MBlockUtils.is.validElement(e)||!e.length||!e.get)return console.warn("MBlock: Invalid element for mblock_sort_it"),!1;const t=e.get(0);return document.contains(t)?"undefined"!=typeof Sortable&&Sortable.create?(MBlockSortable.reinitialize(e),!0):(console.error("MBlock: Sortable.js not available"),!1):(console.warn("MBlock: Element no longer in DOM"),!1)}catch(e){return console.error("MBlock: Error in mblock_sort_it:",e),!1}}function mblock_reindex(e){try{if(!mblock_validate_element(e))return console.warn("MBlock: Invalid element in mblock_reindex"),!1;const t=e.data("mblock_count")||0,o=e.find("> div.sortitem");return!o.length||(o.each(function(e){const o=$(this),n=e+1;o.attr("data-mblock_index",n),mblock_reindex_form_elements(o,e,n,t),mblock_reindex_special_elements(o,e,n,t)}),mblock_replace_for(e),!0)}catch(e){return console.error("MBlock: Error in mblock_reindex:",e),!1}}function mblock_reindex_form_elements(e,t,o,n){try{e.find("input,textarea,select,button").each(function(e){const l=$(this),i=e+1,c=l.attr("name");if(c&&void 0!==c){const e=c.match(/\]\[\d+\]\[/g);if(e){const o=c.replace(e,"]["+t+"][").replace("mblock_new_","");l.attr("name",o)}}const r=l.attr("type");if("checkbox"===r&&l.off("change.mblock").on("change.mblock",function(){$(this).val($(this).is(":checked")?1:0)}),"radio"===r){const e=l.attr("data-value");e&&l.val(e)}mblock_update_rex_ids(l,o,n,i)})}catch(e){console.error("MBlock: Error in mblock_reindex_form_elements:",e)}}function mblock_update_rex_ids(e,t,o,n){try{const l=e.attr("id"),i=e.prop("nodeName");if(!l)return;const c=[{type:"SELECT",patterns:["REX_MEDIALIST_SELECT_","REX_LINKLIST_SELECT_"],handler:(l,i)=>{e.parent().data("eindex",n),e.attr("id",l),i&&e.attr("name",i.replace(/_\d+/,"_"+t+o+"00"+n))}},{type:"INPUT",patterns:["REX_MEDIA_","REX_LINKLIST_","REX_MEDIALIST_"],handler:i=>{const c=e.parent().data("eindex")||n,r=l.replace(/\d+/,t+o+"00"+c);e.attr("id",r),mblock_update_rex_buttons(e,t,o,c)}}].find(e=>e.type===i&&e.patterns.some(e=>l.indexOf(e)>=0));if(c){const i=l.replace(/_\d+/,"_"+t+o+"00"+n),r=e.attr("name");c.handler(i,r)}}catch(e){console.error("MBlock: Error in mblock_update_rex_ids:",e)}}function mblock_update_rex_buttons(e,t,o,n){try{e.parent().find("a.btn-popup").each(function(){const e=$(this),l=e.attr("onclick");if(l){const i=l.replace(/\('?\d+/,"('"+t+o+"00"+n).replace(/_\d+/,"_"+t+o+"00"+n);e.attr("onclick",i)}})}catch(e){console.error("MBlock: Error in mblock_update_rex_buttons:",e)}}function mblock_reindex_special_elements(e,t,o,n){try{e.find('a[data-toggle="tab"]').each(function(e){const t=e+1,l=$(this),i=l.attr("href");if(i){const e=i.replace(/_\d+/,"_"+o+n+"00"+t);l.attr("href",e);const c=l.parent().parent().parent().find(".tab-content "+i);c.length&&c.attr("id",e.replace("#","")),l.off("shown.bs.tab.mblock").on("shown.bs.tab.mblock",function(e){try{const t=$(e.target).attr("href");t&&"undefined"!=typeof localStorage&&localStorage.setItem("selectedTab",t)}catch(e){console.warn("MBlock: LocalStorage not available:",e)}})}}),e.find('a[data-toggle="collapse"]').each(function(e){const t=e+1,l=$(this);if(!l.attr("data-ignore-mblock")){const e=l.attr("data-target");if(e){const i=e.replace(/_\d+/,"_"+o+n+"00"+t);l.attr("data-target",i);const c=l.parent().find(e);c.length&&c.attr("id",i.replace("#",""));const r=l.parent().parent().parent().find(".panel-group");if(r.length){const e="accgr_"+o+n+"00";r.attr("id",e),l.attr("data-parent","#"+e)}}}}),e.find(".custom-link").each(function(e){const t=e+1,l=$(this);if(l.find("input").each(function(){const e=$(this),l=e.attr("id");l&&e.attr("id",l.replace(/\d+/,o+n+"00"+t))}),l.find("a.btn-popup").each(function(){const e=$(this),l=e.attr("id");l&&e.attr("id",l.replace(/\d+/,o+n+"00"+t))}),l.attr("data-id",o+n+"00"+t),"function"==typeof window.mform_custom_link)try{window.mform_custom_link(l)}catch(e){console.warn("MBlock: MForm custom link error:",e)}})}catch(e){console.error("MBlock: Error in mblock_reindex_special_elements:",e)}}function mblock_replace_for(e){e.find("> div.sortitem").each(function(e){var t=$(this);t.find("input:not(:checkbox):not(:radio),textarea,select").each(function(e){var o=$(this),n=o.attr("id"),l=o.attr("name");if(void 0!==n&&!1!==n&&void 0!==l&&!1!==l&&!(n.indexOf("REX_MEDIA")>=0||n.indexOf("REX_LINK")>=0||n.indexOf("redactor")>=0||n.indexOf("markitup")>=0)){var i=t.find('label[for="'+n+'"]');l=l.replace(/(\[|\])/gm,""),o.attr("id",l),i.attr("for",l)}})})}function mblock_add_item(e,t){const o=MBlockUtils.dom.createFromHTML(e.data("mblock-plain-sortitem"));o.find("input:radio, input:checkbox").each(function(){$(this).parent().removeAttr("for")}),o.find("input:radio, input:checkbox").each(function(){$(this).attr("name","mblock_new_"+$(this).attr("name")),$(this).attr("data-value",$(this).val())}),!1===t?e.prepend(o):t.parent().hasClass(e.attr("class"))&&(MBlockSortable.destroy(e),t.after(o),mblock_set_count(e,t)),mblock_set_unique_id(o,!0),mblock_init_sort(e),o.trigger("rex:ready",[o]),setTimeout(function(){if(void 0!==MBlockUtils.nested&&MBlockUtils.nested.initializeNested(o),"function"==typeof $.fn.selectpicker){var e=o.find("select.selectpicker");e.length&&(e.selectpicker({noneSelectedText:"—"}).on("rendered.bs.select",function(){$(this).parent().removeClass("bs3-has-addon")}),e.selectpicker("refresh"))}"function"==typeof $.fn.chosen&&o.find("select.chosen").chosen(),void 0!==MBlockWidgets&&"function"==typeof MBlockWidgets.reinitializeAll&&MBlockWidgets.reinitializeAll(o),o.find("input, select, textarea").trigger("change")},50),setTimeout(function(){o&&o.length&&o.is(":visible")&&mblock_scroll(e,o)},100)}function mblock_set_unique_id(e,t){try{return e&&e.length&&"function"==typeof e.find?(e.find("input").each(function(){try{const e=$(this),o=1==e.attr("data-unique-int");if(1==e.attr("data-unique")||o){let n;n=o?Math.floor(1e12*Math.random()):Math.random().toString(16).slice(2),!0===t&&e.val(""),""!==e.val()&&null!==e.val()||e.val(n)}}catch(e){console.error("MBlock: Error in unique_id generation:",e)}}),!0):(console.warn("MBlock: Invalid item in mblock_set_unique_id"),!1)}catch(e){return console.error("MBlock: Error in mblock_set_unique_id:",e),!1}}function mblock_set_count(e,t){var o=t.next().find("span.mb_count"),n=e.find("> div.sortitem").length;e.data("latest")&&(n=e.data("latest")+1),o.text(n),e.data("latest",n)}function mblock_remove_item(e,t){try{if(!(MBlockUtils.is.validElement(e)&&e.length&&t&&t.length))return console.warn("MBlock: Invalid parameters in mblock_remove_item"),!1;const o=e.data();if(o&&o.hasOwnProperty("delete_confirm")&&!confirm(o.delete_confirm))return!1;const n=t.parent(),l=e.attr("class");if(n.length&&l&&n.hasClass(l)){MBlockSortable.destroy(e);let o=t.prev();return o.length&&o.hasClass("sortitem")||(o=t.next()),MBlockUtils.dom.safeRemove(t)?(mblock_init_sort(e),o&&o.length&&mblock_scroll(e,o),mblock_add_plus(e),!0):(console.error("MBlock: Error removing item"),!1)}return!1}catch(e){return console.error("MBlock: Error in mblock_remove_item:",e),!1}}function mblock_moveup(e,t){var o=t.prev();0!=o.length&&setTimeout(function(){t.insertBefore(o),mblock_reindex(e),mblock_remove(e);let n=o;n.trigger("mblock:change",[n])},150)}function mblock_movedown(e,t){var o=t.next();0!=o.length&&setTimeout(function(){t.insertAfter(o),mblock_reindex(e),mblock_remove(e);let n=o;n.trigger("mblock:change",[n])},150)}function mblock_scroll(e,t){try{if(!(e&&e.length&&t&&t.length))return!1;const o=e.data();if(o&&o.hasOwnProperty("smooth_scroll")&&!0===o.smooth_scroll&&"function"==typeof $.mblockSmoothScroll)return $.mblockSmoothScroll({scrollTarget:t,speed:500}),!0;if(t.length&&t.offset()){const e=t.offset().top,o=$(window).height(),n=$(window).scrollTop();(e<n||e>n+o-200)&&$("html, body").animate({scrollTop:e-100},300)}return!0}catch(e){return console.error("MBlock: Error in mblock_scroll:",e),!1}}function mblock_add(e){try{return MBlockUtils.is.validElement(e)&&e.length?([{selector:MBlockUtils.selectors.addme,event:"click",handler:function(t){t.preventDefault();try{const t=$(this);if(!MBlockUtils.state.isDisabled(t)){const o=t.parents(".sortitem").attr("data-mblock_index");o&&e.attr("data-mblock_clicked_add_item",o),mblock_add_item(e,t.closest('div[class^="sortitem"]'))}}catch(e){console.error("MBlock: Error in addme click handler:",e)}return!1}},{selector:MBlockUtils.selectors.removeme,event:"click",handler:function(t){t.preventDefault();try{const t=$(this);MBlockUtils.state.isDisabled(t)||mblock_remove_item(e,t.closest('div[class^="sortitem"]'))}catch(e){console.error("MBlock: Error in removeme click handler:",e)}return!1}},{selector:MBlockUtils.selectors.moveup,event:"click",handler:function(t){t.preventDefault();try{const t=$(this);MBlockUtils.state.isDisabled(t)||mblock_moveup(e,t.closest('div[class^="sortitem"]'))}catch(e){console.error("MBlock: Error in moveup click handler:",e)}return!1}},{selector:MBlockUtils.selectors.movedown,event:"click",handler:function(t){t.preventDefault();try{const t=$(this);MBlockUtils.state.isDisabled(t)||mblock_movedown(e,t.closest('div[class^="sortitem"]'))}catch(e){console.error("MBlock: Error in movedown click handler:",e)}return!1}}].forEach(({selector:t,event:o,handler:n})=>{const l=MBlockUtils.dom.findElement(e,`${MBlockUtils.selectors.sortitem} ${t}`);MBlockUtils.events.bindSafe(l,o,n)}),checkCopyPasteEnabled()&&mblock_add._bindCopyPasteHandlers(e),mblock_add._bindToggleHandlers(e),checkCopyPasteEnabled()&&void 0!==MBlockClipboard&&MBlockClipboard.updatePasteButtons(),void 0!==MBlockOnlineToggle&&MBlockOnlineToggle.initializeStates(e),!0):(console.warn("MBlock: Invalid element in mblock_add"),!1)}catch(e){return console.error("MBlock: Error in mblock_add:",e),!1}}function mblock_init_toolbar(e){try{return!(!e||!e.length)&&(e.find(".mblock-toolbar").length&&console.log("MBlock: Initializing toolbar for element"),!0)}catch(e){return console.error("MBlock: Error in mblock_init_toolbar:",e),!1}}$(document).on("rex:ready",function(e,t){try{checkCopyPasteEnabled()&&void 0!==MBlockClipboard&&MBlockClipboard.init(),t&&"function"==typeof t.find?t.find(mblock).each(function(){const e=$(this);if(e.length)try{if(t.closest(".mblock_wrapper").length>0)return void console.log("MBlock: Skipping nested rex:ready initialization (handled by parent)");mblock_init(e)}catch(e){console.error("MBlock: Error initializing individual MBlock element:",e)}}):$(mblock).each(function(){const e=$(this);e.length&&mblock_init(e)})}catch(e){console.error("MBlock: Error in rex:ready:",e)}}),mblock_add._bindCopyPasteHandlers=function(e){const t=MBlockUtils.dom.findElement(e,`${MBlockUtils.selectors.sortitem} ${MBlockUtils.selectors.copyBtn}`);t.length>0&&MBlockUtils.events.bindSafe(t,"click",function(t){t.preventDefault();try{const t=$(this).closest('div[class^="sortitem"]');void 0!==MBlockClipboard&&MBlockClipboard.copy(e,t)}catch(e){console.error("MBlock: Error in copy click handler:",e)}return!1});const o=MBlockUtils.dom.findElement(e,`${MBlockUtils.selectors.sortitem} ${MBlockUtils.selectors.pasteBtn}`);o.length>0&&MBlockUtils.events.bindSafe(o,"click",function(t){t.preventDefault();try{const t=$(this);if(!MBlockUtils.state.isDisabled(t)){const o=t.closest('div[class^="sortitem"]');void 0!==MBlockClipboard&&MBlockClipboard.paste(e,o)}}catch(e){console.error("MBlock: Error in paste click handler:",e)}return!1})},mblock_add._bindToggleHandlers=function(e){const t=MBlockUtils.dom.findElement(e,`${MBlockUtils.selectors.sortitem} ${MBlockUtils.selectors.onlineToggle}`);MBlockUtils.events.bindSafe(t,"click",function(t){t.preventDefault();try{const t=$(this).closest('div[class^="sortitem"]');void 0!==MBlockOnlineToggle&&MBlockOnlineToggle.toggle(e,t)}catch(e){console.error("MBlock: Error in online/offline toggle handler:",e)}return!1});const o=MBlockUtils.dom.findElement(e,`${MBlockUtils.selectors.sortitem} ${MBlockUtils.selectors.autoToggle}`);MBlockUtils.events.bindSafe(o,"click",function(t){t.preventDefault();try{const t=$(this),o=t.closest('div[class^="sortitem"]');void 0!==MBlockOnlineToggle&&MBlockOnlineToggle.toggleAutoDetected(e,o,t)}catch(e){console.error("MBlock: Error in auto-detected toggle handler:",e)}return!1})},"undefined"!=typeof module&&module.exports&&(module.exports={MBlockSortable:MBlockSortable});var MBlockClipboard={data:null,storageKey:"mblock_clipboard",useSessionStorage:!0,init:function(){try{this.loadFromStorage(),this.data}catch(e){console.warn("MBlock: Error initializing clipboard:",e)}},getStorage:function(){try{return this.useSessionStorage?sessionStorage:localStorage}catch(e){return console.warn("MBlock: Storage not available, using memory fallback"),null}},loadFromStorage:function(){try{const e=this.getStorage();if(!e)return!1;const t=e.getItem(this.storageKey);if(t)return this.data=JSON.parse(t),console.log("MBlock: Clipboard data loaded from storage"),!0}catch(e){console.warn("MBlock: Error loading from storage:",e)}return!1},saveToStorage:function(){try{const e=this.getStorage();return!(!e||!this.data||(e.setItem(this.storageKey,JSON.stringify(this.data)),console.log("MBlock: Clipboard data saved to storage"),0))}catch(e){return console.warn("MBlock: Error saving to storage:",e),!1}},clearStorage:function(){try{const e=this.getStorage();e&&(e.removeItem(this.storageKey),console.log("MBlock: Clipboard storage cleared"))}catch(e){console.warn("MBlock: Error clearing storage:",e)}},getModuleType:function(e){try{const t=e.attr("data-module-id")||e.attr("data-module")||e.data("module");if(t)return t;const o=(e.attr("class")||"").match(/mblock-module-(\w+)/);if(o)return o[1];const n=e.closest("[data-module], [data-module-id]");if(n.length)return n.attr("data-module")||n.attr("data-module-id");const l=($("form").attr("action")||"").match(/module_id[=\/](\d+)/);return l?"module_"+l[1]:"default_module"}catch(e){return console.warn("MBlock: Error getting module type:",e),"unknown_module"}},showModuleTypeMismatchWarning:function(e,t){console.warn("MBlock: Module type mismatch - cannot paste from",t,"to",e)},copy:function(e,t){try{if(!t||!t.length)return console.warn("MBlock: No item to copy"),!1;const o=e.closest(".mblock_wrapper"),n=this.getModuleType(o);console.log("MBlock: Starting copy operation for module type:",n);const l=t.clone();void 0!==MBlockWidgets&&MBlockWidgets.selectpicker&&MBlockWidgets.selectpicker.convertToPlain(l);const i=this.captureFormData(t);return this.data={html:l.prop("outerHTML"),formData:i,moduleType:n,timestamp:Date.now(),savedAt:(new Date).toLocaleString()},this.saveToStorage(),this.updatePasteButtons(),this.showCopiedState(t),console.log("MBlock: Copy completed for module:",n),!0}catch(e){return console.error("MBlock: Error during copy:",e),!1}},captureFormData:function(e){const t={};try{return e.find("input, textarea, select").each(function(){const e=$(this),o=e.attr("name"),n=e.attr("type")||e.prop("tagName").toLowerCase();o&&(t[o]="checkbox"===n||"radio"===n?{type:"checkbox_radio",value:e.val(),checked:e.is(":checked"),defaultValue:e.attr("value")}:"select"===n?{type:"select",value:e.val(),html:e.html()}:{type:"input",value:e.val(),placeholder:e.attr("placeholder")||""})}),void 0!==MBlockAddonFixes&&MBlockAddonFixes.ckeditor&&MBlockAddonFixes.ckeditor.captureContent(e,t),void 0!==MBlockWidgets&&(MBlockWidgets.link&&MBlockWidgets.link.captureData(e,t),MBlockWidgets.media&&MBlockWidgets.media.captureData(e,t)),t}catch(e){return console.error("MBlock: Error capturing form data:",e),t}},paste:function(e,t){try{if(this.loadFromStorage(),!this.data)return console.warn("MBlock: No data in clipboard"),mblock_show_message("❌ "+mblock_get_text("mblock_toast_clipboard_empty","No data in clipboard"),"warning",3e3),!1;const o=e.closest(".mblock_wrapper"),n=this.getModuleType(o),l=this.data.moduleType||"unknown_module";if(n!==l)return console.warn("MBlock: Module type mismatch. Paste aborted.",{current:n,clipboard:l}),mblock_show_message("⚠️ "+mblock_get_text("mblock_toast_module_type_mismatch","Module type mismatch")+": "+l+" ≠ "+n,"error",4e3),this.showModuleTypeMismatchWarning(n,l),!1;const i=$(this.data.html);return this.cleanupPastedItem(i),t&&t.length?(void 0!==MBlockSortable&&MBlockSortable.destroy(e),t.after(i)):e.prepend(i),mblock_set_unique_id(i,!0),void 0!==MBlockWidgets&&MBlockWidgets.reinitializeAll&&MBlockWidgets.reinitializeAll(i),void 0!==MBlockAddonFixes&&MBlockAddonFixes.ckeditor&&MBlockAddonFixes.ckeditor.destroyInstances(i),this.data.formData&&this.restoreNonCKEditorFormData(i,this.data.formData),mblock_init_sort(e),i.trigger("rex:ready",[i]),void 0!==MBlockUtils.nested&&MBlockUtils.nested.initializeNested(i),this.data.formData&&void 0!==MBlockAddonFixes&&MBlockAddonFixes.ckeditor&&setTimeout(()=>{MBlockAddonFixes.ckeditor.restoreContent(i,this.data.formData)},500),setTimeout(()=>{void 0!==MBlockWidgets&&MBlockWidgets.selectpicker&&MBlockWidgets.selectpicker.initialize(i),i.find("input, select, textarea").trigger("change")},50),setTimeout(()=>{i&&i.length&&i.is(":visible")&&mblock_smooth_scroll_to_element(i[0])},100),setTimeout(()=>{i&&i.length&&i.is(":visible")&&(MBlockUtils.animation.addGlowEffect(i,"mblock-paste-glow",1200),mblock_show_message("✅ "+mblock_get_text("mblock_toast_paste_success","Block successfully pasted!"),"success",4e3))},150),!0}catch(e){return console.error("MBlock: Error during paste:",e),!1}},cleanupPastedItem:function(e){try{e.removeAttr("data-mblock_index"),e.find("input, textarea, select").each(function(){const e=$(this),t=e.attr("name");if(t&&-1===t.indexOf("mblock_new_")&&e.attr("name","mblock_new_"+t),"file"===e.attr("type")&&e.val(""),e.attr("data-unique")&&!e.val()){const t=Math.random().toString(16).slice(2);e.val(t)}}),e.find("[id]").each(function(){const e=$(this),t=e.attr("id");t&&!t.match(/^(REX_|ck)/)&&e.removeAttr("id")})}catch(e){console.error("MBlock: Error cleaning up pasted item:",e)}},restoreNonCKEditorFormData:function(e,t){try{Object.keys(t).forEach(o=>{const n=t[o];if(!n||"object"!=typeof n)return;if("ckeditor"===n.type)return;let l=e.find(`[name="${o}"], [name="mblock_new_${o}"]`);l.length&&this.restoreFieldData(l,n,e,o)})}catch(e){console.error("MBlock: Error restoring non-CKEditor data:",e)}},restoreFieldData:function(e,t,o,n){switch(t.type){case"checkbox_radio":e.val(t.value),e.prop("checked",t.checked),t.defaultValue&&e.attr("value",t.defaultValue);break;case"select":t.html&&e.html(t.html),e.val(t.value);break;case"rex_link":void 0!==MBlockWidgets&&MBlockWidgets.link&&MBlockWidgets.link.restoreData(o,t,e);break;case"rex_media":void 0!==MBlockWidgets&&MBlockWidgets.media&&MBlockWidgets.media.restoreData(o,t,e);break;default:void 0!==t.value&&(e.val(t.value),t.placeholder&&e.attr("placeholder",t.placeholder))}},showCopiedState:function(e){MBlockUtils.animation.addGlowEffect(e,"mblock-copy-glow",1e3),mblock_show_message("📋 "+mblock_get_text("mblock_toast_copy_success","Block successfully copied!"),"success",3e3);const t=e.find(".mblock-copy-btn");t.length&&MBlockUtils.animation.addGlowEffect(t,"is-copied",1e3)},updatePasteButtons:function(){const e=!!this.data;e?$(".mblock_wrapper").each((e,t)=>{const o=$(t),n=this.getModuleType(o),l=this.data.moduleType||"unknown_module",i=o.find(".mblock-paste-btn");n===l?(i.removeClass("disabled").prop("disabled",!1),i.attr("title","Paste element (Module compatible)")):(i.addClass("disabled").prop("disabled",!0),i.attr("title",`Cannot paste: Different module type (Current: ${n}, Clipboard: ${l})`))}):($(".mblock-paste-btn").addClass("disabled").prop("disabled",!0),$(".mblock-paste-btn").attr("title","No data in clipboard"));const t=$(".mblock-copy-paste-toolbar");e?t.show():t.hide(),this.useSessionStorage},clear:function(){this.data=null,this.clearStorage(),this.updatePasteButtons()},getInfo:function(){return{hasData:!!this.data,storageMode:this.useSessionStorage?"Session":"Local",timestamp:this.data?this.data.timestamp:null,savedAt:this.data?this.data.savedAt:null,itemCount:this.data&&this.data.formData?Object.keys(this.data.formData).length:0}}},MBlockOnlineToggle={toggle:function(e,t){try{if(!t||!t.length)return console.warn("MBlock: No item found for Online/Offline Toggle"),!1;const e=!t.hasClass("mblock-offline"),o=t.find(".mblock-online-toggle"),n=o.find("i");return e?(t.addClass("mblock-offline"),o.removeClass("btn-online").addClass("btn-offline").attr("title","Set online"),n.length?n.removeClass("rex-icon-online").addClass("rex-icon-offline"):o.html('<i class="rex-icon rex-icon-offline"></i>'),this.setOfflineState(t,!0)):(t.removeClass("mblock-offline"),o.removeClass("btn-offline").addClass("btn-online").attr("title","Set offline"),n.length?n.removeClass("rex-icon-offline").addClass("rex-icon-online"):o.html('<i class="rex-icon rex-icon-online"></i>'),this.setOfflineState(t,!1)),!0}catch(e){return console.error("MBlock: Error in Online/Offline Toggle:",e),!1}},setOfflineState:function(e,t){try{const o=e.find('input[name*="mblock_offline"]');o.length?o.val(t?"1":"0"):console.warn("MBlock: No mblock_offline input found - must be defined in template for this functionality")}catch(e){console.error("MBlock: Error setting offline status:",e)}},initializeStates:function(e){try{e.find("> div.sortitem").each(function(e){const t=$(this);t.attr("data-mblock_index");let o=t.find('input[name*="mblock_offline"]');o.length||(o=t.find('input[name*="_offline"]')),o.length||(o=t.find('input[value="1"][type="hidden"]'));const n=t.find(".mblock-online-toggle"),l=n.find("i");n.length&&(!o.length||"1"!==o.val()&&1!==o.val()?(t.removeClass("mblock-offline"),n.removeClass("btn-offline").addClass("btn-online").attr("title","Set offline"),l.length?l.removeClass("rex-icon-offline").addClass("rex-icon-online"):n.html('<i class="rex-icon rex-icon-online"></i>')):(t.addClass("mblock-offline"),n.removeClass("btn-online").addClass("btn-offline").attr("title","Set online"),l.length?l.removeClass("rex-icon-online").addClass("rex-icon-offline"):n.html('<i class="rex-icon rex-icon-offline"></i>')))})}catch(e){console.error("MBlock: Error initializing Online/Offline states:",e)}},toggleAutoDetected:function(e,t,o){try{if(!(t&&t.length&&o&&o.length))return console.warn("MBlock: No item or button found for Auto-Detected Toggle"),!1;const e=!("1"===o.attr("data-offline")),n=t.find('input[name*="mblock_offline"]');if(!n.length)return console.warn("MBlock: No mblock_offline input field found in item"),!1;n.val(e?"1":"0");const l=e?"btn-danger":"btn-success",i=e?"rex-icon-offline":"rex-icon-online",c=e?"Set online":"Set offline",r=e?"Offline":"Online";o.removeClass("btn-default btn-warning btn-success btn-danger").addClass(l).attr("title",c).attr("data-offline",e?"1":"0");const a=o.find("i");a.length&&a.removeClass("rex-icon-online rex-icon-offline").addClass(i);const s=o.html().replace(/Offline|Online/,r);return o.html(s),e?t.addClass("mblock-offline"):t.removeClass("mblock-offline"),!0}catch(e){return console.error("MBlock: Error in Auto-Detected Toggle:",e),!1}}};function mblock_init_toolbar(e){try{if(!checkCopyPasteEnabled())return;[{selector:".mblock-copy-paste-toolbar .mblock-paste-btn",handler:function(t){t.preventDefault();try{const t=$(this);MBlockUtils.state.isDisabled(t)||void 0!==MBlockClipboard&&MBlockClipboard.paste(e,!1)}catch(e){console.error("MBlock: Error in toolbar paste click handler:",e)}return!1}},{selector:".mblock-copy-paste-toolbar .mblock-clear-clipboard",handler:function(e){e.preventDefault();try{void 0!==MBlockClipboard&&MBlockClipboard.clear()}catch(e){console.error("MBlock: Error in clear clipboard click handler:",e)}return!1}}].forEach(({selector:t,handler:o})=>{const n=MBlockUtils.dom.findElement(e,t);MBlockUtils.events.bindSafe(n,"click",o)})}catch(e){console.error("MBlock: Error in mblock_init_toolbar:",e)}}"undefined"!=typeof module&&module.exports&&(module.exports={MBlockClipboard:MBlockClipboard,MBlockOnlineToggle:MBlockOnlineToggle});