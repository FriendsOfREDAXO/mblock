function e(e,t="warning",n=5e3){"undefined"!=typeof BLOECKS&&BLOECKS.showToast?BLOECKS.showToast(e,t,n):"error"===t?console.error("MBlock:",e):console.warn("MBlock:",e)}function t(e,t=""){if("undefined"!=typeof rex&&rex.mblock_i18n&&rex.mblock_i18n[e.replace("mblock_toast_","")])return rex.mblock_i18n[e.replace("mblock_toast_","")];if("undefined"!=typeof rex&&rex.i18n){const n=rex.i18n.msg(e);return n!==e?n:t}const n=(navigator.language||"de").substring(0,2),o={mblock_toast_copy_success:{de:"Block erfolgreich kopiert!",en:"Block copied successfully!",es:"\xa1Bloque copiado con \xe9xito!",pt:"Bloco copiado com sucesso!",sv:"Block kopierat framg\xe5ngsrikt!",nl:"Blok succesvol gekopieerd!"},mblock_toast_paste_success:{de:"Block erfolgreich eingef\xfcgt!",en:"Block pasted successfully!",es:"\xa1Bloque pegado con \xe9xito!",pt:"Bloco colado com sucesso!",sv:"Block inklistrat framg\xe5ngsrikt!",nl:"Blok succesvol geplakt!"},mblock_toast_clipboard_empty:{de:"Keine Daten in der Zwischenablage",en:"No data in clipboard",es:"No hay datos en el portapapeles",pt:"Nenhum dado na \xe1rea de transfer\xeancia",sv:"Inga data i urklipp",nl:"Geen gegevens in klembord"},mblock_toast_module_type_mismatch:{de:"Modultyp stimmt nicht \xfcberein",en:"Module type mismatch",es:"No coincide el tipo de m\xf3dulo",pt:"Tipo de m\xf3dulo n\xe3o corresponde",sv:"Modultyp matchar inte",nl:"Moduletype komt niet overeen"}}[e];return o&&o[n]?o[n]:o&&o.de?o.de:t}function mblock_init(e){try{if(!e||!e.length||"function"!=typeof e.data)return console.warn("MBlock: Ung\xfcltiges Element bei mblock_init"),!1;if(!e.data("mblock_run")){e.data("mblock_run",1),mblock_sort(e),l(e,!1);const t=e.data("min"),n=e.data("max");1==t&&1==n&&e.addClass("hide_removeadded").addClass("hide_sorthandle")}return n(e),function(e){try{e.find(".mblock-copy-paste-toolbar .mblock-paste-btn").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.hasClass("disabled")||t.prop("disabled")||MBlockClipboard.paste(e,!1)}catch(n){console.error("MBlock: Fehler in toolbar paste click handler:",n)}return!1}),e.find(".mblock-copy-paste-toolbar .mblock-clear-clipboard").off("click.mblock").on("click.mblock",function(e){e.preventDefault();try{MBlockClipboard.clear()}catch(t){console.error("MBlock: Fehler in clear clipboard click handler:",t)}return!1})}catch(t){console.error("MBlock: Fehler in mblock_init_toolbar:",t)}}(e),MBlockOnlineToggle.initializeStates(e),!0}catch(t){return console.error("MBlock: Fehler in mblock_init:",t),!1}}function mblock_init_sort(e){try{return!(!e||!e.length||(r(e),mblock_sort(e),0))}catch(t){return console.error("MBlock: Fehler in mblock_init_sort:",t),!1}}function mblock_sort(e){try{return!(!e||!e.length||(function(e){try{return e&&e.length?(e.find("> div.sortitem .addme").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);if(!t.prop("disabled")){const n=t.parents(".sortitem").attr("data-mblock_index");n&&e.attr("data-mblock_clicked_add_item",n),i(e,t.closest('div[class^="sortitem"]'))}}catch(n){console.error("MBlock: Fehler in addme click handler:",n)}return!1}),e.find("> div.sortitem .removeme").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.prop("disabled")||function(e,t){try{if(!(e&&e.length&&t&&t.length))return console.warn("MBlock: Ung\xfcltige Parameter bei mblock_remove_item"),!1;const i=e.data();if(i&&i.hasOwnProperty("delete_confirm")&&!confirm(i.delete_confirm))return!1;const l=t.parent(),c=e.attr("class");if(l.length&&c&&l.hasClass(c)){try{const t=e.get(0);t&&t._sortable&&"function"==typeof t._sortable.destroy&&(t._sortable.destroy(),t._sortable=null)}catch(o){console.warn("MBlock: Sortable destroy error in remove_item:",o)}let i=t.prev();i.length&&i.hasClass("sortitem")||(i=t.next());try{t.find("*").off(".mblock"),t.off(".mblock"),t.remove()}catch(r){return console.error("MBlock: Fehler beim Entfernen des Items:",r),!1}return mblock_init_sort(e),i&&i.length&&a(e,i),n(e),!0}return!1}catch(i){return console.error("MBlock: Fehler in mblock_remove_item:",i),!1}}(e,t.closest('div[class^="sortitem"]'))}catch(o){console.error("MBlock: Fehler in removeme click handler:",o)}return!1}),e.find("> div.sortitem .moveup").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.prop("disabled")||function(e,t){var n=t.prev();0!=n.length&&setTimeout(function(){t.insertBefore(n),r(e),o(e),n.trigger("mblock:change",[n])},150)}(e,t.closest('div[class^="sortitem"]'))}catch(n){console.error("MBlock: Fehler in moveup click handler:",n)}return!1}),e.find("> div.sortitem .movedown").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.prop("disabled")||function(e,t){var n=t.next();0!=n.length&&setTimeout(function(){t.insertAfter(n),r(e),o(e),n.trigger("mblock:change",[n])},150)}(e,t.closest('div[class^="sortitem"]'))}catch(n){console.error("MBlock: Fehler in movedown click handler:",n)}return!1}),e.find("> div.sortitem .mblock-copy-btn").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this).closest('div[class^="sortitem"]');MBlockClipboard.copy(e,t)}catch(n){console.error("MBlock: Fehler in copy click handler:",n)}return!1}),e.find("> div.sortitem .mblock-paste-btn").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);if(!t.hasClass("disabled")&&!t.prop("disabled")){const n=t.closest('div[class^="sortitem"]');MBlockClipboard.paste(e,n)}}catch(n){console.error("MBlock: Fehler in paste click handler:",n)}return!1}),e.find("> div.sortitem .mblock-online-toggle").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this).closest('div[class^="sortitem"]');MBlockOnlineToggle.toggle(e,t)}catch(n){console.error("MBlock: Fehler in online/offline toggle handler:",n)}return!1}),e.find("> div.sortitem .mblock-offline-toggle-btn").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this),n=t.closest('div[class^="sortitem"]');MBlockOnlineToggle.toggleAutoDetected(e,n,t)}catch(n){console.error("MBlock: Fehler in auto-detected toggle handler:",n)}return!1}),MBlockClipboard.updatePasteButtons(),MBlockOnlineToggle.initializeStates(e),!0):(console.warn("MBlock: Ung\xfcltiges Element bei mblock_add"),!1)}catch(t){return console.error("MBlock: Fehler in mblock_add:",t),!1}}(e),o(e),function(e){try{if(!(e&&e.length&&e.get&&e.get(0)))return console.warn("MBlock: Ung\xfcltiges Element f\xfcr mblock_sort_it"),!1;const n=e.get(0);if(!document.contains(n))return console.warn("MBlock: Element nicht mehr im DOM"),!1;if("undefined"!=typeof Sortable&&Sortable.create){try{n._sortable&&("function"==typeof n._sortable.destroy&&n._sortable.destroy(),n._sortable=null)}catch(t){console.warn("MBlock: Fehler beim Zerst\xf6ren der vorhandenen Sortable-Instanz:",t),n._sortable=null}return setTimeout(()=>{try{const t=Sortable.create(n,{handle:".sorthandle",animation:150,ghostClass:"sortable-ghost",chosenClass:"mblock-sortable-chosen",dragClass:"mblock-dragging",onStart:function(e){try{document.body.classList.add("mblock-drag-active"),e.item&&e.item.classList.add("mblock-dragging")}catch(t){console.error("MBlock: Fehler in sortable onStart:",t)}},onEnd:function(t){try{document.body.classList.remove("mblock-drag-active"),t.item&&(t.item.classList.remove("mblock-dragging"),t.item.classList.add("mblock-dropped-flash"),setTimeout(()=>{t.item.classList.remove("mblock-dropped-flash")},600)),r(e),o(e);let n=$(t.item);n.length&&n.trigger("mblock:change",[n])}catch(n){console.error("MBlock: Fehler in sortable onEnd:",n)}},onError:function(e){console.error("MBlock: Sortable Fehler:",e)}});n._sortable=t}catch(t){return console.error("MBlock: Fehler beim Erstellen der Sortable-Instanz:",t),!1}},10),!0}return console.error("MBlock: Sortable.js (bloecks Addon) ist erforderlich aber nicht verf\xfcgbar"),!1}catch(n){return console.error("MBlock: Fehler in mblock_sort_it:",n),!1}}(e),0))}catch(t){return console.error("MBlock: Fehler in mblock_sort:",t),!1}}function n(e){e.find("> div.sortitem").length||(e.prepend($($.parseHTML(e.data("mblock-single-add")))),e.find("> div.mblock-single-add .addme").unbind().bind("click",function(){i(e,!1),$(this).parents(".mblock-single-add").remove()}))}function o(e){var t=e.find("> div.sortitem");1==t.length?(t.find(".removeme").prop("disabled",!0),t.find(".removeme").attr("data-disabled",!0)):(t.find(".removeme").prop("disabled",!1),t.find(".removeme").attr("data-disabled",!1)),e.data().hasOwnProperty("max")&&(t.length>=e.data("max")?e.find(".addme").prop("disabled",!0):e.find(".addme").prop("disabled",!1)),e.data().hasOwnProperty("min")&&(t.length<=e.data("min")?e.find(".removeme").prop("disabled",!0):e.find(".removeme").prop("disabled",!1)),t.each(function(n){n+1==e.data("min")&&t.length==e.data("min")&&$(this).find(".removeme").prop("disabled",!0),0==n?$(this).find(".moveup").prop("disabled",!0):$(this).find(".moveup").prop("disabled",!1),n+1==t.length?$(this).find(".movedown").prop("disabled",!0):$(this).find(".movedown").prop("disabled",!1)})}function r(e){try{if(!function(e){try{return!!e&&(e.jquery?e.length>0&&"function"==typeof e.data:!!e.nodeType||"string"==typeof e&&e.length>0)}catch(t){return console.error("MBlock: Fehler bei Element-Validierung:",t),!1}}(e))return console.warn("MBlock: Ung\xfcltiges Element bei mblock_reindex"),!1;const t=e.data("mblock_count")||0,n=e.find("> div.sortitem");return!n.length||(n.each(function(e){const n=$(this),o=e+1;n.attr("data-mblock_index",o),function(e,t,n,o){try{e.find("input,textarea,select,button").each(function(e){const r=$(this),i=e+1,l=r.attr("name");if(l&&void 0!==l){const e=l.match(/\]\[\d+\]\[/g);if(e){const n=l.replace(e,"]["+t+"][").replace("mblock_new_","");r.attr("name",n)}}const a=r.attr("type");if("checkbox"===a&&r.off("change.mblock").on("change.mblock",function(){$(this).val($(this).is(":checked")?1:0)}),"radio"===a){const e=r.attr("data-value");e&&r.val(e)}!function(e,t,n,o){try{const r=e.attr("id"),i=e.prop("nodeName");if(!r)return;if("SELECT"===i&&(r.indexOf("REX_MEDIALIST_SELECT_")>=0||r.indexOf("REX_LINKLIST_SELECT_")>=0)){e.parent().data("eindex",o);const i=r.replace(/_\d+/,"_"+t+n+"00"+o);e.attr("id",i);const l=e.attr("name");l&&e.attr("name",l.replace(/_\d+/,"_"+t+n+"00"+o))}if("INPUT"===i&&(r.indexOf("REX_LINKLIST_")>=0||r.indexOf("REX_MEDIALIST_")>=0)){const i=e.parent().data("eindex")||o,l=r.replace(/\d+/,t+n+"00"+i);e.attr("id",l),function(e,t,n,o){try{e.parent().find("a.btn-popup").each(function(){const e=$(this),r=e.attr("onclick");if(r){const i=r.replace(/\('?\d+/,"('"+t+n+"00"+o).replace(/_\d+/,"_"+t+n+"00"+o);e.attr("onclick",i)}})}catch(r){console.error("MBlock: Fehler in mblock_update_rex_buttons:",r)}}(e,t,n,i)}}catch(r){console.error("MBlock: Fehler in mblock_update_rex_ids:",r)}}(r,n,o,i)})}catch(r){console.error("MBlock: Fehler in mblock_reindex_form_elements:",r)}}(n,e,o,t),function(e,t,n,o){try{e.find('a[data-toggle="tab"]').each(function(e){const t=e+1,r=$(this),i=r.attr("href");if(i){const e=i.replace(/_\d+/,"_"+n+o+"00"+t);r.attr("href",e);const l=r.parent().parent().parent().find(".tab-content "+i);l.length&&l.attr("id",e.replace("#","")),r.off("shown.bs.tab.mblock").on("shown.bs.tab.mblock",function(e){try{const t=$(e.target).attr("href");t&&"undefined"!=typeof localStorage&&localStorage.setItem("selectedTab",t)}catch(t){console.warn("MBlock: LocalStorage nicht verf\xfcgbar:",t)}})}}),e.find('a[data-toggle="collapse"]').each(function(e){const t=e+1,r=$(this);if(!r.attr("data-ignore-mblock")){const e=r.attr("data-target");if(e){const i=e.replace(/_\d+/,"_"+n+o+"00"+t);r.attr("data-target",i);const l=r.parent().find(e);l.length&&l.attr("id",i.replace("#",""));const a=r.parent().parent().parent().find(".panel-group");if(a.length){const e="accgr_"+n+o+"00";a.attr("id",e),r.attr("data-parent","#"+e)}}}}),e.find(".custom-link").each(function(e){const t=e+1,r=$(this);if(r.find("input").each(function(){const e=$(this),r=e.attr("id");r&&e.attr("id",r.replace(/\d+/,n+o+"00"+t))}),r.find("a.btn-popup").each(function(){const e=$(this),r=e.attr("id");r&&e.attr("id",r.replace(/\d+/,n+o+"00"+t))}),r.attr("data-id",n+o+"00"+t),"function"==typeof window.mform_custom_link)try{window.mform_custom_link(r)}catch(i){console.warn("MBlock: MForm custom link Fehler:",i)}})}catch(r){console.error("MBlock: Fehler in mblock_reindex_special_elements:",r)}}(n,0,o,t)}),function(e){e.find("> div.sortitem").each(function(){var e=$(this);e.find("input:not(:checkbox):not(:radio),textarea,select").each(function(){var t,n=$(this),o=n.attr("id"),r=n.attr("name");void 0!==o&&!1!==o&&void 0!==r&&!1!==r&&(o.indexOf("REX_MEDIA")>=0||o.indexOf("REX_LINK")>=0||o.indexOf("redactor")>=0||o.indexOf("markitup")>=0||(t=e.find('label[for="'+o+'"]'),r=r.replace(/(\[|\])/gm,""),n.attr("id",r),t.attr("for",r)))})})}(e),!0)}catch(t){return console.error("MBlock: Fehler in mblock_reindex:",t),!1}}function i(e,t){var n=$($.parseHTML(e.data("mblock-plain-sortitem")));if(n.find("input:radio, input:checkbox").each(function(){$(this).parent().removeAttr("for")}),n.find("input:radio, input:checkbox").each(function(){$(this).attr("name","mblock_new_"+$(this).attr("name")),$(this).attr("data-value",$(this).val())}),!1===t)e.prepend(n);else if(t.parent().hasClass(e.attr("class"))){try{const t=e.get(0);t&&t._sortable&&"function"==typeof t._sortable.destroy&&(t._sortable.destroy(),t._sortable=null)}catch(o){console.warn("MBlock: Sortable destroy error in add_item:",o)}t.after(n),function(e,t){var n=t.next().find("span.mb_count"),o=e.find("> div.sortitem").length;e.data("latest")&&(o=e.data("latest")+1),n.text(o),e.data("latest",o)}(e,t)}l(n,!0),mblock_init_sort(e),n.trigger("rex:ready",[n]),setTimeout(function(){if("function"==typeof $.fn.selectpicker){var e=n.find("select.selectpicker");e.length&&(e.selectpicker({noneSelectedText:"\u2014"}).on("rendered.bs.select",function(){$(this).parent().removeClass("bs3-has-addon")}),e.selectpicker("refresh"))}"function"==typeof $.fn.chosen&&n.find("select.chosen").chosen(),n.find("input, select, textarea").trigger("change")},50),setTimeout(function(){n&&n.length&&n.is(":visible")&&a(e,n)},100)}function l(e,t){try{return e&&e.length&&"function"==typeof e.find?(e.find("input").each(function(){try{const e=$(this),n=1==e.attr("data-unique-int");if(1==e.attr("data-unique")||n){let o;o=n?Math.floor(1e12*Math.random()):Math.random().toString(16).slice(2),!0===t&&e.val(""),""!==e.val()&&null!==e.val()||e.val(o)}}catch(e){console.error("MBlock: Fehler bei unique_id Generierung:",e)}}),!0):(console.warn("MBlock: Ung\xfcltiges Item bei mblock_set_unique_id"),!1)}catch(n){return console.error("MBlock: Fehler in mblock_set_unique_id:",n),!1}}function a(e,t){try{if(!(e&&e.length&&t&&t.length))return!1;const n=e.data();if(n&&n.hasOwnProperty("smooth_scroll")&&!0===n.smooth_scroll&&"function"==typeof $.mblockSmoothScroll)return $.mblockSmoothScroll({scrollTarget:t,speed:500}),!0;if(t.length&&t.offset()){const e=t.offset().top,n=$(window).height(),o=$(window).scrollTop();(e<o||e>o+n-200)&&$("html, body").animate({scrollTop:e-100},300)}return!0}catch(n){return console.error("MBlock: Fehler in mblock_scroll:",n),!1}}var MBlockClipboard,MBlockOnlineToggle;let c=".mblock_wrapper";$(document).on("rex:ready",function(e,t){try{MBlockClipboard.init(),t&&"function"==typeof t.find?t.find(c).each(function(){const e=$(this);if(e.length)try{mblock_init(e)}catch(t){console.error("MBlock: Fehler beim Initialisieren eines einzelnen MBlock-Elements:",t)}}):$(c).each(function(){const e=$(this);e.length&&mblock_init(e)})}catch(n){console.error("MBlock: Fehler bei rex:ready:",n)}}),MBlockClipboard={data:null,storageKey:"mblock_clipboard",useSessionStorage:!0,init:function(){try{this.loadFromStorage()}catch(e){console.warn("MBlock: Fehler beim Initialisieren des Clipboards:",e)}},getStorage:function(){try{return this.useSessionStorage?sessionStorage:localStorage}catch(e){return console.warn("MBlock: Storage nicht verf\xfcgbar:",e),null}},saveToStorage:function(){try{const e=this.getStorage();if(e&&this.data)return e.setItem(this.storageKey,JSON.stringify({...this.data,savedAt:(new Date).toISOString(),sessionId:this.getSessionId()})),!0}catch(e){console.warn("MBlock: Fehler beim Speichern in Storage:",e)}return!1},loadFromStorage:function(){try{const e=this.getStorage();if(e){const t=e.getItem(this.storageKey);if(t){const e=JSON.parse(t);if(!this.useSessionStorage&&e.savedAt){const t=new Date(e.savedAt);if((new Date-t)/36e5>24)return this.clearStorage(),!1}return this.data=e,this.updatePasteButtons(),!0}}}catch(e){console.warn("MBlock: Fehler beim Laden aus Storage:",e),this.clearStorage()}return!1},clearStorage:function(){try{const e=this.getStorage();e&&e.removeItem(this.storageKey)}catch(e){console.warn("MBlock: Fehler beim Leeren des Storages:",e)}},getSessionId:function(){return this._sessionId||(this._sessionId=Date.now().toString()+Math.random().toString(36).substr(2,9)),this._sessionId},toggleStorageMode:function(){const e=this.data;return this.clearStorage(),this.useSessionStorage=!this.useSessionStorage,e&&(this.data=e,this.saveToStorage()),this.useSessionStorage},showModuleTypeMismatchWarning:function(e,t){try{const n=`\n                <div class="alert alert-warning mblock-type-warning" style="margin: 10px 0; position: relative; z-index: 1000;">\n                    <strong>Achtung:</strong> Das kopierte Element stammt aus einem anderen Modul-Typ. \n                    Das Einf\xfcgen ist nicht m\xf6glich.<br>\n                    <small>Aktueller Typ: <code>${e}</code> | Zwischenablage: <code>${t}</code></small>\n                    <button type="button" class="close" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; font-size: 18px;" onclick="$(this).parent().fadeOut()">&times;</button>\n                </div>\n            `,o=$(".mblock_wrapper").first();o.length?($(".mblock-type-warning").remove(),o.prepend(n),setTimeout(function(){$(".mblock-type-warning").fadeOut("slow")},5e3)):alert("Das kopierte Element stammt aus einem anderen Modul und kann hier nicht eingef\xfcgt werden.")}catch(n){console.error("MBlock: Fehler beim Anzeigen der Modultyp-Warnung:",n),alert("Das kopierte Element kann hier nicht eingef\xfcgt werden (anderer Modul-Typ).")}},getModuleType:function(e){try{const t=e.closest("form");if(t.length){const e=t.find('input[name="module_id"]').first();if(e.length){const t=e.val();if(t)return"module_"+t}}const n=e.find('input[name="module_id"]').first();if(n.length){const e=n.val();if(e)return"module_"+e}const o=e.find('input[name*="module_id"], input[name*="module_name"]').first();if(o.length){const e=o.val();if(e)return"module_"+e}if(t.length){const e=(t.attr("action")||"").match(/module_id=(\d+)/);if(e)return"module_"+e[1]}const r=(e.attr("class")||"").match(/mblock-module-(\w+)/);if(r)return r[1];const i=e.closest("[id]");if(i.length){const e=i.attr("id");if(e.includes("module"))return e}const l=new URLSearchParams(window.location.search),a=l.get("module_id")||l.get("article_id");return a?"context_"+a:(console.warn("MBlock: Keine Modul-ID erkannt - verwende unknown_module"),"unknown_module")}catch(t){return console.warn("MBlock: Fehler beim Ermitteln des Modultyps:",t),"unknown_module"}},copy:function(e,t){try{if(!t||!t.length)return console.warn("MBlock: Kein Item zum Kopieren gefunden"),!1;const n=t.closest(".mblock_wrapper"),o=this.getModuleType(n),r=t.clone(!0,!0);this.convertSelectpickerToPlainSelect(r);const i=this.captureComplexFormData(t);return this.data={html:r.prop("outerHTML"),formData:i,moduleType:o,timestamp:Date.now(),source:e.attr("class")||"mblock_wrapper"},this.showCopiedState(t),this.saveToStorage(),this.updatePasteButtons(),!0}catch(n){return console.error("MBlock: Fehler beim Kopieren:",n),!1}},captureComplexFormData:function(e){const t={};try{return e.find("input, textarea, select").each(function(){const e=$(this),n=e.attr("name")||e.attr("id");if(n)if(e.is(":checkbox")||e.is(":radio"))t[n]={type:"checkbox_radio",value:e.val(),checked:e.prop("checked"),defaultValue:e.attr("value")};else if(e.is("select")){const o=[];e.find("option:selected").each(function(){o.push($(this).val())}),t[n]={type:"select",value:e.val(),selectedOptions:o,html:e.html()}}else t[n]={type:"input",value:e.val(),placeholder:e.attr("placeholder")}}),e.find(".cke5-editor").each(function(){const e=$(this),n=e.attr("name");if(n){let o=e.val();const r=e.attr("id");r&&window.CKEDITOR&&window.CKEDITOR.instances[r]&&(o=window.CKEDITOR.instances[r].getData()),t[n]={type:"ckeditor",value:o,config:{lang:e.attr("data-lang"),profile:e.attr("data-profile")}}}}),e.find(".rex-js-widget-media").each(function(){const e=$(this),n=e.find('input[id^="REX_MEDIA_"]');if(n.length){const o=n.attr("name"),r=n.attr("id");t[o||r]={type:"rex_media",value:n.val(),mediaId:r,preview:e.find(".rex-js-media-preview").html()}}}),e.find(".rex-js-widget-customlink").each(function(){const e=$(this),n=e.find('input[type="hidden"]'),o=e.find("input[readonly]");if(n.length){const r=n.attr("name");t[r]={type:"rex_link",value:n.val(),displayText:o.length?o.val():"",dataId:e.attr("data-id"),dataClang:e.attr("data-clang")}}}),e.find(".bootstrap-select select").each(function(){const e=$(this),n=e.attr("name");n&&(t[n+"_bootstrap"]={type:"bootstrap_select",value:e.val(),selectedText:e.find("option:selected").text(),title:e.closest(".bootstrap-select").find(".filter-option-inner-inner").text()})}),e.find(".nav-tabs .active a").each(function(e){const n=$(this),o=n.attr("href");o&&(t["active_tab_"+e]={type:"active_tab",href:o,text:n.text()})}),e.find(".collapse.in, .collapse.show").each(function(){const e=$(this).attr("id");e&&(t["collapse_state_"+e]={type:"collapse_state",isOpen:!0})}),t}catch(n){return console.error("MBlock: Fehler beim Erfassen der Formulardaten:",n),t}},paste:function(n,o){try{if(this.loadFromStorage(),!this.data)return console.warn("MBlock: Keine Daten in der Zwischenablage"),e("\u274c "+t("mblock_toast_clipboard_empty","Keine Daten in der Zwischenablage"),"warning",3e3),!1;const i=n.closest(".mblock_wrapper"),a=this.getModuleType(i),c=this.data.moduleType||"unknown_module";if(a!==c)return console.warn("MBlock: Modultyp stimmt nicht \xfcberein. Paste abgebrochen.",{current:a,clipboard:c}),e("\u26a0\ufe0f "+t("mblock_toast_module_type_mismatch","Modultyp stimmt nicht \xfcberein")+": "+c+" \u2260 "+a,"error",4e3),this.showModuleTypeMismatchWarning(a,c),!1;const s=$(this.data.html);if(this.cleanupPastedItem(s),this.data.formData&&this.restoreComplexFormData(s,this.data.formData),o&&o.length){try{const e=n.get(0);e&&e._sortable&&"function"==typeof e._sortable.destroy&&(e._sortable.destroy(),e._sortable=null)}catch(r){console.warn("MBlock: Sortable destroy error in paste:",r)}o.after(s)}else n.prepend(s);return l(s,!0),mblock_init_sort(n),s.trigger("rex:ready",[s]),setTimeout(function(){if("function"==typeof $.fn.selectpicker){var e=s.find("select.mblock-needs-selectpicker");e.length&&(e.removeClass("mblock-needs-selectpicker").addClass("selectpicker"),e.selectpicker({noneSelectedText:"\u2014"}).on("rendered.bs.select",function(){$(this).parent().removeClass("bs3-has-addon")}),e.selectpicker("refresh"))}"function"==typeof $.fn.chosen&&s.find("select.chosen").chosen(),s.find("input, select, textarea").trigger("change")},50),setTimeout(function(){s&&s.length&&s.is(":visible")&&function(e,t={}){if(!e)return;if("undefined"!=typeof BLOECKS&&"function"==typeof BLOECKS.scrollToSlice)try{return void BLOECKS.scrollToSlice(e)}catch(o){console.warn("MBlock: Bloecks scroll failed, using fallback:",o)}const n={behavior:"smooth",block:"center",inline:"nearest",offset:-20,...t};try{if("scrollIntoView"in e){const t=e.getBoundingClientRect().top+window.pageYOffset;window.scrollTo({top:Math.max(0,t+n.offset),behavior:n.behavior})}else e.scrollIntoView({behavior:n.behavior,block:n.block,inline:n.inline})}catch(o){try{e.scrollIntoView()}catch(r){console.warn("MBlock: Smooth scroll nicht verf\xfcgbar:",r)}}}(s[0])},100),setTimeout(function(){if(s&&s.length&&s.is(":visible")){if(s.addClass("mblock-paste-glow"),"undefined"!=typeof BLOECKS&&BLOECKS.showToast){const e="\u2705 "+t("mblock_toast_paste_success","Block erfolgreich eingef\xfcgt!");BLOECKS.showToast(e,"success",4e3)}setTimeout(function(){s.removeClass("mblock-paste-glow")},1200)}},150),!0}catch(i){return console.error("MBlock: Fehler beim Einf\xfcgen:",i),!1}},cleanupPastedItem:function(e){try{e.removeAttr("data-mblock_index"),e.find("input, textarea, select").each(function(){const e=$(this),t=e.attr("name");if(t&&-1===t.indexOf("mblock_new_")&&e.attr("name","mblock_new_"+t),"file"===e.attr("type")&&e.val(""),e.attr("data-unique")&&!e.val()){const t=Math.random().toString(16).slice(2);e.val(t)}}),e.find("[id]").each(function(){const e=$(this),t=e.attr("id");t&&!t.match(/^REX_/)&&e.removeAttr("id")})}catch(t){console.error("MBlock: Fehler beim Bereinigen des eingef\xfcgten Items:",t)}},findFieldBySmartMatching:function(e,t){let n=e.find(`[name="${t}"]`);if(n.length)return n;if(n=e.find(`[name="mblock_new_${t}"]`),n.length)return n;if(t.includes("REX_INPUT_VALUE")||t.includes("REX_LINK")){const o=this.extractREDAXOFieldPatterns(t);for(const t of o)if(n=e.find(`[name*="${t}"]`),n.length)return n}const o=t.replace(/^mblock_new_/,"");return n=e.find(`[name*="${o}"]`),n},extractREDAXOFieldPatterns:function(e){const t=[],n=e.match(/REX_INPUT_VALUE\[.*?\]\[.*?\]\[(.+?)\]/);n&&(t.push(n[1]),t.push(`[${n[1]}]`));const o=e.match(/REX_LINK_(\d+)(_\w+)?/);o&&(t.push("REX_LINK"),o[2]&&t.push(o[2]));const r=e.match(/REX_MEDIA_(\d+)(_\w+)?/);return r&&(t.push("REX_MEDIA"),r[2]&&t.push(r[2])),t},restoreComplexFormData:function(e,t){try{Object.keys(t).forEach(n=>{const o=t[n];if(!o||"object"!=typeof o)return;let r=this.findFieldBySmartMatching(e,n);if(r.length)switch(o.type){case"checkbox_radio":r.val(o.value),r.prop("checked",o.checked),o.defaultValue&&r.attr("value",o.defaultValue);break;case"select":o.html&&r.html(o.html),r.val(o.value),o.selectedOptions&&o.selectedOptions.length>0&&o.selectedOptions.forEach(e=>{r.find(`option[value="${e}"]`).prop("selected",!0)});break;case"bootstrap_select":r.val(o.value),"function"==typeof r.selectpicker&&setTimeout(()=>{r.selectpicker("refresh"),r.selectpicker("val",o.value)},100);break;case"ckeditor":if(o.value){r.val(o.value);const e=r.attr("id");e&&window.CKEDITOR&&window.CKEDITOR.instances[e]&&setTimeout(()=>{window.CKEDITOR.instances[e].setData(o.value)},200)}break;case"rex_media":if(o.value&&(r.val(o.value),o.preview)){const e=r.closest(".rex-js-widget-media").find(".rex-js-media-preview");e.length&&(e.html(o.preview),o.value&&e.show())}break;case"rex_link":if(r.val(o.value),o.displayText){const e=r.siblings("input[readonly]");e.length&&e.val(o.displayText)}const t=r.closest(".rex-js-widget-customlink");t.length&&(o.dataId&&t.attr("data-id",o.dataId),o.dataClang&&t.attr("data-clang",o.dataClang));break;case"active_tab":o.href&&setTimeout(()=>{const t=e.find(`a[href="${o.href}"]`);t.length&&t.tab("show")},300);break;case"collapse_state":if(o.isOpen){const t=n.replace("collapse_state_","");setTimeout(()=>{const n=e.find(`#${t}`);n.length&&n.collapse("show")},400)}break;default:void 0!==o.value&&(r.val(o.value),o.placeholder&&r.attr("placeholder",o.placeholder))}else n.includes("_bootstrap")||n.includes("active_tab")||console.warn(`MBlock: Feld "${n}" nicht gefunden`)})}catch(n){console.error("MBlock: Fehler beim Wiederherstellen komplexer Formulardaten:",n)}},showCopiedState:function(e){if(e.addClass("mblock-copy-glow"),setTimeout(()=>{e.removeClass("mblock-copy-glow")},1e3),"undefined"!=typeof BLOECKS&&BLOECKS.showToast){const e="\ud83d\udccb "+t("mblock_toast_copy_success","Block erfolgreich kopiert!");BLOECKS.showToast(e,"success",3e3)}const n=e.find(".mblock-copy-btn");n.length&&(n.addClass("is-copied"),setTimeout(()=>{n.removeClass("is-copied")},1e3))},updatePasteButtons:function(){const e=!!this.data;e?$(".mblock_wrapper").each((e,t)=>{const n=$(t),o=this.getModuleType(n),r=this.data.moduleType||"unknown_module",i=n.find(".mblock-paste-btn");o===r?(i.removeClass("disabled").prop("disabled",!1),i.attr("title","Paste element (Module kompatibel)")):(i.addClass("disabled").prop("disabled",!0),i.attr("title",`Cannot paste: Different module type (Current: ${o}, Clipboard: ${r})`))}):($(".mblock-paste-btn").addClass("disabled").prop("disabled",!0),$(".mblock-paste-btn").attr("title","No data in clipboard"));const t=$(".mblock-copy-paste-toolbar");e?t.show():t.hide()},convertSelectpickerToPlainSelect:function(e){try{e.find("select.selectpicker, .bootstrap-select select").each(function(){const e=$(this),t=e.val(),n=(e.prop("outerHTML"),e.clone());n.removeClass("selectpicker bs-select-hidden"),n.removeAttr("data-live-search data-live-search-placeholder tabindex aria-describedby"),n.removeData(),n.css("display",""),n.addClass("mblock-needs-selectpicker"),n.val(t);const o=e.parents(".bootstrap-select");o.length>0?o.last().replaceWith(n):e.replaceWith(n)}),e.find(".bootstrap-select").each(function(){const e=$(this);e.find("select").length||e.remove()})}catch(t){console.error("MBlock: Error converting selectpicker to plain select:",t)}},clear:function(){this.data=null,this.clearStorage(),this.updatePasteButtons()},getInfo:function(){return{hasData:!!this.data,storageMode:this.useSessionStorage?"Session":"Local",timestamp:this.data?this.data.timestamp:null,savedAt:this.data?this.data.savedAt:null,itemCount:this.data&&this.data.formData?Object.keys(this.data.formData).length:0}}},MBlockOnlineToggle={toggle:function(e,t){try{if(!t||!t.length)return console.warn("MBlock: Kein Item f\xfcr Online/Offline Toggle gefunden"),!1;const e=!t.hasClass("mblock-offline"),n=t.find(".mblock-online-toggle"),o=n.find("i");return e?(t.addClass("mblock-offline"),n.removeClass("btn-online").addClass("btn-offline").attr("title","Set online"),o.length?o.removeClass("rex-icon-online").addClass("rex-icon-offline"):n.html('<i class="rex-icon rex-icon-offline"></i>'),this.setOfflineState(t,!0)):(t.removeClass("mblock-offline"),n.removeClass("btn-offline").addClass("btn-online").attr("title","Set offline"),o.length?o.removeClass("rex-icon-offline").addClass("rex-icon-online"):n.html('<i class="rex-icon rex-icon-online"></i>'),this.setOfflineState(t,!1)),!0}catch(n){return console.error("MBlock: Fehler beim Online/Offline Toggle:",n),!1}},setOfflineState:function(e,t){try{const n=e.find('input[name*="mblock_offline"]');n.length?n.val(t?"1":"0"):console.warn("MBlock: No mblock_offline input found - must be defined in template for this functionality")}catch(n){console.error("MBlock: Fehler beim Setzen des Offline-Status:",n)}},initializeStates:function(e){try{e.find("> div.sortitem").each(function(){const e=$(this);e.attr("data-mblock_index");let t=e.find('input[name*="mblock_offline"]');t.length||(t=e.find('input[name*="_offline"]')),t.length||(t=e.find('input[value="1"][type="hidden"]'));const n=e.find(".mblock-online-toggle"),o=n.find("i");n.length&&(!t.length||"1"!==t.val()&&1!==t.val()?(e.removeClass("mblock-offline"),n.removeClass("btn-offline").addClass("btn-online").attr("title","Set offline"),o.length?o.removeClass("rex-icon-offline").addClass("rex-icon-online"):n.html('<i class="rex-icon rex-icon-online"></i>')):(e.addClass("mblock-offline"),n.removeClass("btn-online").addClass("btn-offline").attr("title","Set online"),o.length?o.removeClass("rex-icon-online").addClass("rex-icon-offline"):n.html('<i class="rex-icon rex-icon-offline"></i>')))})}catch(t){console.error("MBlock: Fehler beim Initialisieren der Online/Offline-States:",t)}},toggleAutoDetected:function(e,t,n){try{if(!(t&&t.length&&n&&n.length))return console.warn("MBlock: Kein Item oder Button f\xfcr Auto-Detected Toggle gefunden"),!1;const e=!("1"===n.attr("data-offline")),o=t.find('input[name*="mblock_offline"]');if(!o.length)return console.warn("MBlock: No mblock_offline input field found in item"),!1;o.val(e?"1":"0");const r=e?"btn-danger":"btn-success",i=e?"rex-icon-offline":"rex-icon-online",l=e?"Set online":"Set offline",a=e?"Offline":"Online";n.removeClass("btn-default btn-warning btn-success btn-danger").addClass(r).attr("title",l).attr("data-offline",e?"1":"0");const c=n.find("i");c.length&&c.removeClass("rex-icon-online rex-icon-offline").addClass(i);const s=n.html().replace(/Offline|Online/,a);return n.html(s),e?t.addClass("mblock-offline"):t.removeClass("mblock-offline"),!0}catch(o){return console.error("MBlock: Fehler beim Auto-Detected Toggle:",o),!1}}};
//# sourceMappingURL=mblock.min.js.map