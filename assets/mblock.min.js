let mblock=".mblock_wrapper";function mblock_show_message(e,t="warning",o=5e3){"undefined"!=typeof BLOECKS&&BLOECKS.fireMBlockToast?BLOECKS.fireMBlockToast(e,t,o):"undefined"!=typeof BLOECKS&&BLOECKS.showToast?BLOECKS.showToast(e,t,o):"error"===t||"danger"===t?console.error("MBlock:",e):console.warn("MBlock:",e)}function mblock_get_text(e,t=""){if("undefined"!=typeof rex&&rex.mblock_i18n&&rex.mblock_i18n[e.replace("mblock_toast_","")])return rex.mblock_i18n[e.replace("mblock_toast_","")];if("undefined"!=typeof rex&&rex.i18n){const o=rex.i18n.msg(e);return o!==e?o:t}const o=(navigator.language||"de").substring(0,2),n={mblock_toast_copy_success:{de:"Block erfolgreich kopiert!",en:"Block copied successfully!",es:"¡Bloque copiado con éxito!",pt:"Bloco copiado com sucesso!",sv:"Block kopierat framgångsrikt!",nl:"Blok succesvol gekopieerd!"},mblock_toast_paste_success:{de:"Block erfolgreich eingefügt!",en:"Block pasted successfully!",es:"¡Bloque pegado con éxito!",pt:"Bloco colado com sucesso!",sv:"Block inklistrat framgångsrikt!",nl:"Blok succesvol geplakt!"},mblock_toast_clipboard_empty:{de:"Keine Daten in der Zwischenablage",en:"No data in clipboard",es:"No hay datos en el portapapeles",pt:"Nenhum dado na área de transferência",sv:"Inga data i urklipp",nl:"Geen gegevens in klembord"},mblock_toast_module_type_mismatch:{de:"Modultyp stimmt nicht überein",en:"Module type mismatch",es:"No coincide el tipo de módulo",pt:"Tipo de módulo não corresponde",sv:"Modultyp matchar inte",nl:"Moduletype komt niet overeen"}}[e];return n&&n[o]?n[o]:n&&n.de?n.de:t}function mblock_validate_element(e){try{return!!e&&(e.jquery?e.length>0&&"function"==typeof e.data:!!e.nodeType||"string"==typeof e&&e.length>0)}catch(e){return console.error("MBlock: Fehler bei Element-Validierung:",e),!1}}function mblock_cleanup_events(e,t=".mblock"){try{mblock_validate_element(e)&&e.jquery&&(e.find("*").off(t),e.off(t))}catch(e){console.error("MBlock: Fehler bei Event-Cleanup:",e)}}function checkCopyPasteEnabled(){try{const e=$(mblock).first();if(e.length){const t=e.attr("data-copy_paste");if(void 0!==t)return"1"===t||"true"===t||!0===t}const t=$(".mblock-copy-btn").length>0,o=$(".mblock-copy-paste-toolbar").length>0;return t||o}catch(e){return console.warn("MBlock: Fehler beim Prüfen der Copy/Paste-Konfiguration:",e),!0}}function mblock_init(e){try{if(!e||!e.length||"function"!=typeof e.data)return console.warn("MBlock: Ungültiges Element bei mblock_init"),!1;if(!e.data("mblock_run")){e.data("mblock_run",1),mblock_sort(e),mblock_set_unique_id(e,!1);const t=e.data("min"),o=e.data("max");1==t&&1==o&&e.addClass("hide_removeadded").addClass("hide_sorthandle")}return mblock_add_plus(e),mblock_init_toolbar(e),MBlockOnlineToggle.initializeStates(e),!0}catch(e){return console.error("MBlock: Fehler in mblock_init:",e),!1}}function mblock_init_sort(e){try{return!(!e||!e.length||(mblock_reindex(e),mblock_sort(e),0))}catch(e){return console.error("MBlock: Fehler in mblock_init_sort:",e),!1}}function mblock_sort(e){try{return!(!e||!e.length||(mblock_add(e),mblock_remove(e),mblock_sort_it(e),0))}catch(e){return console.error("MBlock: Fehler in mblock_sort:",e),!1}}function mblock_add_plus(e){e.find("> div.sortitem").length||(e.prepend($($.parseHTML(e.data("mblock-single-add")))),e.find("> div.mblock-single-add .addme").unbind().bind("click",function(){mblock_add_item(e,!1),$(this).parents(".mblock-single-add").remove()}))}function mblock_remove(e){var t=e.find("> div.sortitem");1==t.length?(t.find(".removeme").prop("disabled",!0),t.find(".removeme").attr("data-disabled",!0)):(t.find(".removeme").prop("disabled",!1),t.find(".removeme").attr("data-disabled",!1)),e.data().hasOwnProperty("max")&&(t.length>=e.data("max")?e.find(".addme").prop("disabled",!0):e.find(".addme").prop("disabled",!1)),e.data().hasOwnProperty("min")&&(t.length<=e.data("min")?e.find(".removeme").prop("disabled",!0):e.find(".removeme").prop("disabled",!1)),t.each(function(o){o+1==e.data("min")&&t.length==e.data("min")&&$(this).find(".removeme").prop("disabled",!0),0==o?$(this).find(".moveup").prop("disabled",!0):$(this).find(".moveup").prop("disabled",!1),o+1==t.length?$(this).find(".movedown").prop("disabled",!0):$(this).find(".movedown").prop("disabled",!1)})}function mblock_sort_it(e){try{if(!(e&&e.length&&e.get&&e.get(0)))return console.warn("MBlock: Ungültiges Element für mblock_sort_it"),!1;const t=e.get(0);if(!document.contains(t))return console.warn("MBlock: Element nicht mehr im DOM"),!1;if("undefined"!=typeof Sortable&&Sortable.create){try{t._sortable&&("function"==typeof t._sortable.destroy&&t._sortable.destroy(),t._sortable=null)}catch(e){console.warn("MBlock: Fehler beim Zerstören der vorhandenen Sortable-Instanz:",e),t._sortable=null}return setTimeout(()=>{try{const o=Sortable.create(t,{handle:".sorthandle",animation:150,ghostClass:"sortable-ghost",chosenClass:"mblock-sortable-chosen",dragClass:"mblock-dragging",onStart:function(e){try{document.body.classList.add("mblock-drag-active"),e.item&&e.item.classList.add("mblock-dragging")}catch(e){console.error("MBlock: Fehler in sortable onStart:",e)}},onEnd:function(t){try{document.body.classList.remove("mblock-drag-active"),t.item&&(t.item.classList.remove("mblock-dragging"),t.item.classList.add("mblock-dropped-flash"),setTimeout(()=>{t.item.classList.remove("mblock-dropped-flash")},600)),mblock_reindex(e),mblock_remove(e);let o=$(t.item);o.length&&o.trigger("mblock:change",[o])}catch(e){console.error("MBlock: Fehler in sortable onEnd:",e)}},onError:function(e){console.error("MBlock: Sortable Fehler:",e)}});t._sortable=o}catch(e){return console.error("MBlock: Fehler beim Erstellen der Sortable-Instanz:",e),!1}},10),!0}return console.error("MBlock: Sortable.js (bloecks Addon) ist erforderlich aber nicht verfügbar"),!1}catch(e){return console.error("MBlock: Fehler in mblock_sort_it:",e),!1}}function mblock_reindex(e){try{if(!mblock_validate_element(e))return console.warn("MBlock: Ungültiges Element bei mblock_reindex"),!1;const t=e.data("mblock_count")||0,o=e.find("> div.sortitem");return!o.length||(o.each(function(e){const o=$(this),n=e+1;o.attr("data-mblock_index",n),mblock_reindex_form_elements(o,e,n,t),mblock_reindex_special_elements(o,e,n,t)}),mblock_replace_for(e),!0)}catch(e){return console.error("MBlock: Fehler in mblock_reindex:",e),!1}}function mblock_reindex_form_elements(e,t,o,n){try{e.find("input,textarea,select,button").each(function(e){const i=$(this),l=e+1,c=i.attr("name");if(c&&void 0!==c){const e=c.match(/\]\[\d+\]\[/g);if(e){const o=c.replace(e,"]["+t+"][").replace("mblock_new_","");i.attr("name",o)}}const a=i.attr("type");if("checkbox"===a&&i.off("change.mblock").on("change.mblock",function(){$(this).val($(this).is(":checked")?1:0)}),"radio"===a){const e=i.attr("data-value");e&&i.val(e)}mblock_update_rex_ids(i,o,n,l)})}catch(e){console.error("MBlock: Fehler in mblock_reindex_form_elements:",e)}}function mblock_update_rex_ids(e,t,o,n){try{const i=e.attr("id"),l=e.prop("nodeName");if(!i)return;if("SELECT"===l&&(i.indexOf("REX_MEDIALIST_SELECT_")>=0||i.indexOf("REX_LINKLIST_SELECT_")>=0)){e.parent().data("eindex",n);const l=i.replace(/_\d+/,"_"+t+o+"00"+n);e.attr("id",l);const c=e.attr("name");c&&e.attr("name",c.replace(/_\d+/,"_"+t+o+"00"+n))}if("INPUT"===l&&(i.indexOf("REX_MEDIA_")>=0||i.indexOf("REX_LINKLIST_")>=0||i.indexOf("REX_MEDIALIST_")>=0)){const l=e.parent().data("eindex")||n,c=i.replace(/\d+/,t+o+"00"+l);e.attr("id",c),mblock_update_rex_buttons(e,t,o,l)}}catch(e){console.error("MBlock: Fehler in mblock_update_rex_ids:",e)}}function mblock_update_rex_buttons(e,t,o,n){try{e.parent().find("a.btn-popup").each(function(){const e=$(this),i=e.attr("onclick");if(i){const l=i.replace(/\('?\d+/,"('"+t+o+"00"+n).replace(/_\d+/,"_"+t+o+"00"+n);e.attr("onclick",l)}})}catch(e){console.error("MBlock: Fehler in mblock_update_rex_buttons:",e)}}function mblock_reindex_special_elements(e,t,o,n){try{e.find('a[data-toggle="tab"]').each(function(e){const t=e+1,i=$(this),l=i.attr("href");if(l){const e=l.replace(/_\d+/,"_"+o+n+"00"+t);i.attr("href",e);const c=i.parent().parent().parent().find(".tab-content "+l);c.length&&c.attr("id",e.replace("#","")),i.off("shown.bs.tab.mblock").on("shown.bs.tab.mblock",function(e){try{const t=$(e.target).attr("href");t&&"undefined"!=typeof localStorage&&localStorage.setItem("selectedTab",t)}catch(e){console.warn("MBlock: LocalStorage nicht verfügbar:",e)}})}}),e.find('a[data-toggle="collapse"]').each(function(e){const t=e+1,i=$(this);if(!i.attr("data-ignore-mblock")){const e=i.attr("data-target");if(e){const l=e.replace(/_\d+/,"_"+o+n+"00"+t);i.attr("data-target",l);const c=i.parent().find(e);c.length&&c.attr("id",l.replace("#",""));const a=i.parent().parent().parent().find(".panel-group");if(a.length){const e="accgr_"+o+n+"00";a.attr("id",e),i.attr("data-parent","#"+e)}}}}),e.find(".custom-link").each(function(e){const t=e+1,i=$(this);if(i.find("input").each(function(){const e=$(this),i=e.attr("id");i&&e.attr("id",i.replace(/\d+/,o+n+"00"+t))}),i.find("a.btn-popup").each(function(){const e=$(this),i=e.attr("id");i&&e.attr("id",i.replace(/\d+/,o+n+"00"+t))}),i.attr("data-id",o+n+"00"+t),"function"==typeof window.mform_custom_link)try{window.mform_custom_link(i)}catch(e){console.warn("MBlock: MForm custom link Fehler:",e)}})}catch(e){console.error("MBlock: Fehler in mblock_reindex_special_elements:",e)}}function mblock_replace_for(e){e.find("> div.sortitem").each(function(e){var t=$(this);t.find("input:not(:checkbox):not(:radio),textarea,select").each(function(e){var o=$(this),n=o.attr("id"),i=o.attr("name");if(void 0!==n&&!1!==n&&void 0!==i&&!1!==i&&!(n.indexOf("REX_MEDIA")>=0||n.indexOf("REX_LINK")>=0||n.indexOf("redactor")>=0||n.indexOf("markitup")>=0)){var l=t.find('label[for="'+n+'"]');i=i.replace(/(\[|\])/gm,""),o.attr("id",i),l.attr("for",i)}})})}function mblock_add_item(e,t){var o=$($.parseHTML(e.data("mblock-plain-sortitem")));if(o.find("input:radio, input:checkbox").each(function(){$(this).parent().removeAttr("for")}),o.find("input:radio, input:checkbox").each(function(){$(this).attr("name","mblock_new_"+$(this).attr("name")),$(this).attr("data-value",$(this).val())}),!1===t)e.prepend(o);else if(t.parent().hasClass(e.attr("class"))){try{const t=e.get(0);t&&t._sortable&&"function"==typeof t._sortable.destroy&&(t._sortable.destroy(),t._sortable=null)}catch(e){console.warn("MBlock: Sortable destroy error in add_item:",e)}t.after(o),mblock_set_count(e,t)}mblock_set_unique_id(o,!0),mblock_init_sort(e),o.trigger("rex:ready",[o]),setTimeout(function(){if("function"==typeof $.fn.selectpicker){var e=o.find("select.selectpicker");e.length&&(e.selectpicker({noneSelectedText:"—"}).on("rendered.bs.select",function(){$(this).parent().removeClass("bs3-has-addon")}),e.selectpicker("refresh"))}"function"==typeof $.fn.chosen&&o.find("select.chosen").chosen(),mblock_reinitialize_redaxo_widgets(o),o.find("input, select, textarea").trigger("change")},50),setTimeout(function(){o&&o.length&&o.is(":visible")&&mblock_scroll(e,o)},100)}function mblock_set_unique_id(e,t){try{return e&&e.length&&"function"==typeof e.find?(e.find("input").each(function(){try{const e=$(this),o=1==e.attr("data-unique-int");if(1==e.attr("data-unique")||o){let n;n=o?Math.floor(1e12*Math.random()):Math.random().toString(16).slice(2),!0===t&&e.val(""),""!==e.val()&&null!==e.val()||e.val(n)}}catch(e){console.error("MBlock: Fehler bei unique_id Generierung:",e)}}),!0):(console.warn("MBlock: Ungültiges Item bei mblock_set_unique_id"),!1)}catch(e){return console.error("MBlock: Fehler in mblock_set_unique_id:",e),!1}}function mblock_set_count(e,t){var o=t.next().find("span.mb_count"),n=e.find("> div.sortitem").length;e.data("latest")&&(n=e.data("latest")+1),o.text(n),e.data("latest",n)}function mblock_remove_item(e,t){try{if(!(e&&e.length&&t&&t.length))return console.warn("MBlock: Ungültige Parameter bei mblock_remove_item"),!1;const o=e.data();if(o&&o.hasOwnProperty("delete_confirm")&&!confirm(o.delete_confirm))return!1;const n=t.parent(),i=e.attr("class");if(n.length&&i&&n.hasClass(i)){try{const t=e.get(0);t&&t._sortable&&"function"==typeof t._sortable.destroy&&(t._sortable.destroy(),t._sortable=null)}catch(e){console.warn("MBlock: Sortable destroy error in remove_item:",e)}let o=t.prev();o.length&&o.hasClass("sortitem")||(o=t.next());try{t.find("*").off(".mblock"),t.off(".mblock"),t.remove()}catch(e){return console.error("MBlock: Fehler beim Entfernen des Items:",e),!1}return mblock_init_sort(e),o&&o.length&&mblock_scroll(e,o),mblock_add_plus(e),!0}return!1}catch(e){return console.error("MBlock: Fehler in mblock_remove_item:",e),!1}}$(document).on("rex:ready",function(e,t){try{checkCopyPasteEnabled()&&MBlockClipboard.init(),t&&"function"==typeof t.find?t.find(mblock).each(function(){const e=$(this);if(e.length)try{mblock_init(e)}catch(e){console.error("MBlock: Fehler beim Initialisieren eines einzelnen MBlock-Elements:",e)}}):$(mblock).each(function(){const e=$(this);e.length&&mblock_init(e)})}catch(e){console.error("MBlock: Fehler bei rex:ready:",e)}});var MBlockClipboard={data:null,storageKey:"mblock_clipboard",useSessionStorage:!0,init:function(){try{this.loadFromStorage(),this.data}catch(e){console.warn("MBlock: Fehler beim Initialisieren des Clipboards:",e)}},getStorage:function(){try{return this.useSessionStorage?sessionStorage:localStorage}catch(e){return console.warn("MBlock: Storage nicht verfügbar:",e),null}},saveToStorage:function(){try{const e=this.getStorage();if(e&&this.data)return e.setItem(this.storageKey,JSON.stringify({...this.data,savedAt:(new Date).toISOString(),sessionId:this.getSessionId()})),!0}catch(e){console.warn("MBlock: Fehler beim Speichern in Storage:",e)}return!1},loadFromStorage:function(){try{const e=this.getStorage();if(e){const t=e.getItem(this.storageKey);if(t){const e=JSON.parse(t);if(!this.useSessionStorage&&e.savedAt){const t=new Date(e.savedAt);if((new Date-t)/36e5>24)return this.clearStorage(),!1}return this.data=e,this.updatePasteButtons(),!0}}}catch(e){console.warn("MBlock: Fehler beim Laden aus Storage:",e),this.clearStorage()}return!1},clearStorage:function(){try{const e=this.getStorage();e&&e.removeItem(this.storageKey)}catch(e){console.warn("MBlock: Fehler beim Leeren des Storages:",e)}},getSessionId:function(){return this._sessionId||(this._sessionId=Date.now().toString()+Math.random().toString(36).substr(2,9)),this._sessionId},toggleStorageMode:function(){const e=this.data;return this.clearStorage(),this.useSessionStorage=!this.useSessionStorage,e&&(this.data=e,this.saveToStorage()),this.useSessionStorage},showModuleTypeMismatchWarning:function(e,t){try{const o=`\n                <div class="alert alert-warning mblock-type-warning" style="margin: 10px 0; position: relative; z-index: 1000;">\n                    <strong>Achtung:</strong> Das kopierte Element stammt aus einem anderen Modul-Typ. \n                    Das Einfügen ist nicht möglich.<br>\n                    <small>Aktueller Typ: <code>${e}</code> | Zwischenablage: <code>${t}</code></small>\n                    <button type="button" class="close" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; font-size: 18px;" onclick="$(this).parent().fadeOut()">&times;</button>\n                </div>\n            `,n=$(".mblock_wrapper").first();n.length?($(".mblock-type-warning").remove(),n.prepend(o),setTimeout(function(){$(".mblock-type-warning").fadeOut("slow")},5e3)):alert("Das kopierte Element stammt aus einem anderen Modul und kann hier nicht eingefügt werden.")}catch(e){console.error("MBlock: Fehler beim Anzeigen der Modultyp-Warnung:",e),alert("Das kopierte Element kann hier nicht eingefügt werden (anderer Modul-Typ).")}},getModuleType:function(e){try{const t=e.closest("form");if(t.length){const e=t.find('input[name="module_id"]').first();if(e.length){const t=e.val();if(t)return"module_"+t}}const o=e.find('input[name="module_id"]').first();if(o.length){const e=o.val();if(e)return"module_"+e}const n=e.find('input[name*="module_id"], input[name*="module_name"]').first();if(n.length){const e=n.val();if(e)return"module_"+e}if(t.length){const e=(t.attr("action")||"").match(/module_id=(\d+)/);if(e)return"module_"+e[1]}const i=(e.attr("class")||"").match(/mblock-module-(\w+)/);if(i)return i[1];const l=e.closest("[id]");if(l.length){const e=l.attr("id");if(e.includes("module"))return e}const c=new URLSearchParams(window.location.search),a=c.get("module_id")||c.get("article_id");return a?"context_"+a:(console.warn("MBlock: Keine Modul-ID erkannt - verwende unknown_module"),"unknown_module")}catch(e){return console.warn("MBlock: Fehler beim Ermitteln des Modultyps:",e),"unknown_module"}},copy:function(e,t){try{if(!t||!t.length)return console.warn("MBlock: Kein Item zum Kopieren gefunden"),!1;const o=t.closest(".mblock_wrapper"),n=this.getModuleType(o),i=t.clone(!0,!0);this.convertSelectpickerToPlainSelect(i);const l=this.captureComplexFormData(t);return this.data={html:i.prop("outerHTML"),formData:l,moduleType:n,timestamp:Date.now(),source:e.attr("class")||"mblock_wrapper"},this.showCopiedState(t),this.saveToStorage(),this.updatePasteButtons(),!0}catch(e){return console.error("MBlock: Fehler beim Kopieren:",e),!1}},captureComplexFormData:function(e){const t={};try{return e.find("input, textarea, select").each(function(){const e=$(this),o=e.attr("name")||e.attr("id");if(o)if(e.is(":checkbox")||e.is(":radio"))t[o]={type:"checkbox_radio",value:e.val(),checked:e.prop("checked"),defaultValue:e.attr("value")};else if(e.is("select")){const n=[];e.find("option:selected").each(function(){n.push($(this).val())}),t[o]={type:"select",value:e.val(),selectedOptions:n,html:e.html()}}else t[o]={type:"input",value:e.val(),placeholder:e.attr("placeholder")}}),e.find(".cke5-editor").each(function(){const e=$(this),o=e.attr("name");if(o){let n=e.val();const i=e.attr("id");i&&window.CKEDITOR&&window.CKEDITOR.instances[i]&&(n=window.CKEDITOR.instances[i].getData()),t[o]={type:"ckeditor",value:n,config:{lang:e.attr("data-lang"),profile:e.attr("data-profile")}}}}),e.find(".rex-js-widget-media").each(function(){const e=$(this),o=e.find('input[id^="REX_MEDIA_"]');if(o.length){const n=o.attr("name"),i=o.attr("id");t[n||i]={type:"rex_media",value:o.val(),mediaId:i,preview:e.find(".rex-js-media-preview").html()}}}),e.find(".rex-js-widget-customlink").each(function(){const e=$(this),o=e.find('input[type="hidden"]'),n=e.find("input[readonly]");if(o.length){const i=o.attr("name");t[i]={type:"rex_link",value:o.val(),displayText:n.length?n.val():"",dataId:e.attr("data-id"),dataClang:e.attr("data-clang")}}}),e.find('input[id^="REX_LINK_"]').each(function(){const e=$(this),o=e.attr("id");if(o&&!o.includes("_NAME")&&"hidden"===e.attr("type")&&!e.closest(".rex-js-widget-customlink").length){const n=e.attr("name"),i=o+"_NAME";let l=$("#"+i),c="",a="",r=!1;if(l.length)c=l.val()||"",a=l.attr("name")||i;else{const e=o.match(/REX_LINK_(\d+)$/);if(e){const t=e[1];l=$('input[name="REX_LINK_NAME['+t+']"]'),l.length&&(c=l.val()||"",a=l.attr("name"),r=!0)}}t[n]={type:"rex_link_normal",value:e.val(),displayText:c,hiddenId:o,nameId:i,nameFieldName:a,isCorePowered:r},console.log("MBlock: REX_LINK erfasst beim Kopieren:",{name:n,value:e.val(),displayText:c,hiddenId:o,isCorePowered:r})}}),e.find(".bootstrap-select select").each(function(){const e=$(this),o=e.attr("name");o&&(t[o+"_bootstrap"]={type:"bootstrap_select",value:e.val(),selectedText:e.find("option:selected").text(),title:e.closest(".bootstrap-select").find(".filter-option-inner-inner").text()})}),e.find('input[id^="REX_LINKLIST_"]').each(function(){const e=$(this),o=e.attr("id"),n=e.attr("name");if(o&&n&&"hidden"===e.attr("type")){const i=o.match(/REX_LINKLIST_(\d+)$/);if(i){const l=i[1],c=$("#REX_LINKLIST_SELECT_"+l);if(c.length){const i=[];c.find("option").each(function(){const e=$(this);i.push({value:e.val(),text:e.text(),selected:e.prop("selected")})}),t[n]={type:"rex_linklist",value:e.val(),selectName:c.attr("name"),selectId:c.attr("id"),hiddenId:o,linklistId:l,options:i},console.log("MBlock: REX_LINKLIST erfasst beim Kopieren:",{name:n,value:e.val(),options:i.length,linklistId:l})}}}}),e.find(".nav-tabs .active a").each(function(e){const o=$(this),n=o.attr("href");n&&(t["active_tab_"+e]={type:"active_tab",href:n,text:o.text()})}),e.find(".collapse.in, .collapse.show").each(function(e){const o=$(this).attr("id");o&&(t["collapse_state_"+o]={type:"collapse_state",isOpen:!0})}),t}catch(e){return console.error("MBlock: Fehler beim Erfassen der Formulardaten:",e),t}},paste:function(e,t){try{if(this.loadFromStorage(),!this.data)return console.warn("MBlock: Keine Daten in der Zwischenablage"),mblock_show_message("❌ "+mblock_get_text("mblock_toast_clipboard_empty","Keine Daten in der Zwischenablage"),"warning",3e3),!1;const o=e.closest(".mblock_wrapper"),n=this.getModuleType(o),i=this.data.moduleType||"unknown_module";if(n!==i)return console.warn("MBlock: Modultyp stimmt nicht überein. Paste abgebrochen.",{current:n,clipboard:i}),mblock_show_message("⚠️ "+mblock_get_text("mblock_toast_module_type_mismatch","Modultyp stimmt nicht überein")+": "+i+" ≠ "+n,"error",4e3),this.showModuleTypeMismatchWarning(n,i),!1;const l=$(this.data.html);if(this.cleanupPastedItem(l),t&&t.length){try{const t=e.get(0);t&&t._sortable&&"function"==typeof t._sortable.destroy&&(t._sortable.destroy(),t._sortable=null)}catch(e){console.warn("MBlock: Sortable destroy error in paste:",e)}t.after(l)}else e.prepend(l);return mblock_set_unique_id(l,!0),mblock_reinitialize_redaxo_widgets(l),this.data.formData&&this.restoreComplexFormData(l,this.data.formData),mblock_init_sort(e),l.trigger("rex:ready",[l]),setTimeout(()=>{this.data.formData&&this.restoreLinklistDataDelayed(l,this.data.formData),this.repairRexLinkFieldsInTabs(l,this.data)},100),setTimeout(function(){if("function"==typeof $.fn.selectpicker){var e=l.find("select.mblock-needs-selectpicker");e.length&&(e.removeClass("mblock-needs-selectpicker").addClass("selectpicker"),e.selectpicker({noneSelectedText:"—"}).on("rendered.bs.select",function(){$(this).parent().removeClass("bs3-has-addon")}),e.selectpicker("refresh"))}"function"==typeof $.fn.chosen&&l.find("select.chosen").chosen(),l.find("input, select, textarea").trigger("change")},50),setTimeout(function(){l&&l.length&&l.is(":visible")&&mblock_smooth_scroll_to_element(l[0])},100),setTimeout(function(){if(l&&l.length&&l.is(":visible")){if(l.addClass("mblock-paste-glow"),"undefined"!=typeof BLOECKS&&BLOECKS.fireMBlockToast){const e="✅ "+mblock_get_text("mblock_toast_paste_success","Block erfolgreich eingefügt!");BLOECKS.fireMBlockToast(e,"success",4e3)}else if("undefined"!=typeof BLOECKS&&BLOECKS.showToast){const e="✅ "+mblock_get_text("mblock_toast_paste_success","Block erfolgreich eingefügt!");BLOECKS.showToast(e,"success",4e3)}setTimeout(function(){l.removeClass("mblock-paste-glow")},1200)}},150),!0}catch(e){return console.error("MBlock: Fehler beim Einfügen:",e),!1}},cleanupPastedItem:function(e){try{e.removeAttr("data-mblock_index"),e.find("input, textarea, select").each(function(){const e=$(this),t=e.attr("name");if(t&&-1===t.indexOf("mblock_new_")&&e.attr("name","mblock_new_"+t),"file"===e.attr("type")&&e.val(""),e.attr("data-unique")&&!e.val()){const t=Math.random().toString(16).slice(2);e.val(t)}}),e.find("[id]").each(function(){const e=$(this),t=e.attr("id");t&&!t.match(/^REX_/)&&e.removeAttr("id")})}catch(e){console.error("MBlock: Fehler beim Bereinigen des eingefügten Items:",e)}},findFieldBySmartMatching:function(e,t){let o=e.find(`[name="${t}"]`);if(o.length)return o;if(o=e.find(`[name="mblock_new_${t}"]`),o.length)return o;if(t.includes("REX_INPUT_VALUE")||t.includes("REX_LINK")){const n=this.extractREDAXOFieldPatterns(t);for(const t of n)if(o=e.find(`[name*="${t}"]`),o.length)return o}const n=t.replace(/^mblock_new_/,"");return o=e.find(`[name*="${n}"]`),o},extractREDAXOFieldPatterns:function(e){const t=[],o=e.match(/REX_INPUT_VALUE\[.*?\]\[.*?\]\[(.+?)\]/);o&&(t.push(o[1]),t.push(`[${o[1]}]`));const n=e.match(/REX_LINK_(\d+)(_\w+)?/);n&&(t.push("REX_LINK"),n[2]&&t.push(n[2]));const i=e.match(/REX_MEDIA_(\d+)(_\w+)?/);return i&&(t.push("REX_MEDIA"),i[2]&&t.push(i[2])),t},restoreComplexFormData:function(e,t){try{Object.keys(t).forEach(o=>{const n=t[o];if(!n||"object"!=typeof n)return;let i=this.findFieldBySmartMatching(e,o);if(i.length)switch(n.type){case"checkbox_radio":i.val(n.value),i.prop("checked",n.checked),n.defaultValue&&i.attr("value",n.defaultValue);break;case"select":n.html&&i.html(n.html),i.val(n.value),n.selectedOptions&&n.selectedOptions.length>0&&n.selectedOptions.forEach(e=>{i.find(`option[value="${e}"]`).prop("selected",!0)});break;case"bootstrap_select":i.val(n.value),"function"==typeof i.selectpicker&&setTimeout(()=>{i.selectpicker("refresh"),i.selectpicker("val",n.value)},100);break;case"ckeditor":if(n.value){i.val(n.value);const e=i.attr("id");e&&window.CKEDITOR&&window.CKEDITOR.instances[e]&&setTimeout(()=>{window.CKEDITOR.instances[e].setData(n.value)},200)}break;case"rex_media":if(n.value&&(i.val(n.value),n.preview)){const e=i.closest(".rex-js-widget-media").find(".rex-js-media-preview");e.length&&(e.html(n.preview),n.value&&e.show())}break;case"rex_link":if(i.val(n.value),n.displayText){const e=i.siblings("input[readonly]");e.length&&e.val(n.displayText)}const t=i.closest(".rex-js-widget-customlink");t.length&&(n.dataId&&t.attr("data-id",n.dataId),n.dataClang&&t.attr("data-clang",n.dataClang));break;case"rex_link_normal":let l;if(i.val(n.value),console.log("MBlock: Normales REX_LINK wiederhergestellt:",n.value,"für",i.attr("name"),n.isCorePowered?"(Core)":"(HTML)"),n.isCorePowered&&n.nameFieldName)l=$('input[name="'+n.nameFieldName+'"]');else{const e=i.attr("id");e&&(l=$("#"+e+"_NAME"))}l&&l.length&&n.value&&(n.displayText?(l.val(n.displayText),l.trigger("input").trigger("change"),console.log("MBlock: REX_LINK Display Text aus Cache wiederhergestellt:",n.displayText)):mblock_fetch_article_name(n.value,l));break;case"rex_linklist":i.val(n.value),console.log("MBlock: REX_LINKLIST wiederhergestellt:",n.value,"für",i.attr("name"),"ID:",i.attr("id"));const c=i.attr("id");if(c&&n.options){const e=c.match(/REX_LINKLIST_(\d+)$/);if(e){const t=e[1],o=$("#REX_LINKLIST_SELECT_"+t);console.log("MBlock: Suche SELECT-Element:","REX_LINKLIST_SELECT_"+t,"gefunden:",o.length),o.length?(o.empty(),n.options.forEach(function(e){const t=$("<option></option>").val(e.value).text(e.text);e.selected&&t.prop("selected",!0),o.append(t)}),console.log("MBlock: REX_LINKLIST SELECT wiederhergestellt mit",n.options.length,"Optionen"),o.trigger("change")):console.warn("MBlock: SELECT-Element nicht gefunden für ID:",t)}}break;case"active_tab":n.href&&setTimeout(()=>{const t=e.find(`a[href="${n.href}"]`);t.length&&t.tab("show")},300);break;case"collapse_state":if(n.isOpen){const t=o.replace("collapse_state_","");setTimeout(()=>{const o=e.find(`#${t}`);o.length&&o.collapse("show")},400)}break;default:void 0!==n.value&&(i.val(n.value),n.placeholder&&i.attr("placeholder",n.placeholder))}else o.includes("_bootstrap")||o.includes("active_tab")||console.warn(`MBlock: Feld "${o}" nicht gefunden für Typ: ${n.type}`)})}catch(e){console.error("MBlock: Fehler beim Wiederherstellen komplexer Formulardaten:",e)}},restoreLinklistDataDelayed:function(e,t){try{Object.keys(t).forEach(o=>{const n=t[o];if(!n||"object"!=typeof n||"rex_linklist"!==n.type)return;const i=this.findFieldBySmartMatching(e,o);if(!i.length)return void console.warn("MBlock: LINKLIST Delayed - Feld nicht gefunden:",o);i.val(n.value),console.log("MBlock: LINKLIST Delayed wiederhergestellt:",n.value,"ID:",i.attr("id"));const l=i.attr("id");if(l&&n.options){const e=l.match(/REX_LINKLIST_(\d+)$/);if(e){const t=e[1],o=$("#REX_LINKLIST_SELECT_"+t);console.log("MBlock: LINKLIST Delayed - SELECT-Element:","REX_LINKLIST_SELECT_"+t,"gefunden:",o.length),o.length&&(o.empty(),n.options.forEach(function(e){const t=$("<option></option>").val(e.value).text(e.text);e.selected&&t.prop("selected",!0),o.append(t)}),console.log("MBlock: LINKLIST Delayed - SELECT wiederhergestellt mit",n.options.length,"Optionen"),o.trigger("change"))}}})}catch(e){console.error("MBlock: Fehler bei verzögerter LINKLIST-Wiederherstellung:",e)}},repairRexLinkFieldsInTabs:function(e,t){try{console.log("[MBlock] Repariere REX_LINK Felder in Tabs..."),e.find('input[id*="REX_LINK_"][id$="_NAME"]').each(function(){const o=$(this),n=o.val();if(!n)return;const i=o.attr("id").replace("_NAME",""),l=e.find("#"+i);if(0===l.length)return void console.warn("[MBlock] Hidden Field nicht gefunden für:",i);const c=l.val(),a=o.closest(".tab-pane").length>0;if(console.log("[MBlock] REX_LINK Tab-Repair Check:",{displayField:o.attr("id"),displayValue:n,hiddenField:i,hiddenValue:c,inTab:a,needsRepair:!c}),!c){if(console.log("[MBlock] Versuche Reparatur für REX_LINK:",i,"mit Display-Text:",n),n.match(/^\d+$/))return console.log("[MBlock] Verwende numerischen Display-Wert als ID:",n),l.val(n),void l.trigger("change");if(t&&t.formData){const e=l.attr("name");e&&(e.replace("mblock_new_",""),Object.keys(t.formData).forEach(e=>{const o=t.formData[e];if(o&&"rex_link_normal"===o.type&&o.displayText===n&&o.value)return console.log("[MBlock] Verwende ursprüngliche ID aus Clipboard:",o.value,"für Display-Text:",n),l.val(o.value),void l.trigger("change")}))}setTimeout(()=>{l.val()||console.warn("[MBlock] Konnte keine passende ID für REX_LINK finden:",n,"- Feld bleibt leer. Möglicherweise muss der Link manuell neu gesetzt werden.")},1e3)}})}catch(e){console.error("[MBlock] Fehler beim Reparieren von REX_LINK Feldern in Tabs:",e)}},showCopiedState:function(e){if(e.addClass("mblock-copy-glow"),setTimeout(()=>{e.removeClass("mblock-copy-glow")},1e3),"undefined"!=typeof BLOECKS&&BLOECKS.fireMBlockToast){const e="📋 "+mblock_get_text("mblock_toast_copy_success","Block erfolgreich kopiert!");BLOECKS.fireMBlockToast(e,"success",3e3)}else if("undefined"!=typeof BLOECKS&&BLOECKS.showToast){const e="📋 "+mblock_get_text("mblock_toast_copy_success","Block erfolgreich kopiert!");BLOECKS.showToast(e,"success",3e3)}const t=e.find(".mblock-copy-btn");t.length&&(t.addClass("is-copied"),setTimeout(()=>{t.removeClass("is-copied")},1e3))},updatePasteButtons:function(){const e=!!this.data;e?$(".mblock_wrapper").each((e,t)=>{const o=$(t),n=this.getModuleType(o),i=this.data.moduleType||"unknown_module",l=o.find(".mblock-paste-btn");n===i?(l.removeClass("disabled").prop("disabled",!1),l.attr("title","Paste element (Module kompatibel)")):(l.addClass("disabled").prop("disabled",!0),l.attr("title",`Cannot paste: Different module type (Current: ${n}, Clipboard: ${i})`))}):($(".mblock-paste-btn").addClass("disabled").prop("disabled",!0),$(".mblock-paste-btn").attr("title","No data in clipboard"));const t=$(".mblock-copy-paste-toolbar");e?t.show():t.hide(),this.useSessionStorage},convertSelectpickerToPlainSelect:function(e){try{e.find("select.selectpicker, .bootstrap-select select").each(function(){const e=$(this),t=e.val(),o=(e.prop("outerHTML"),e.clone());o.removeClass("selectpicker bs-select-hidden"),o.removeAttr("data-live-search data-live-search-placeholder tabindex aria-describedby"),o.removeData(),o.css("display",""),o.addClass("mblock-needs-selectpicker"),o.val(t);const n=e.parents(".bootstrap-select");n.length>0?n.last().replaceWith(o):e.replaceWith(o)}),e.find(".bootstrap-select").each(function(){const e=$(this);e.find("select").length||e.remove()})}catch(e){console.error("MBlock: Error converting selectpicker to plain select:",e)}},clear:function(){this.data=null,this.clearStorage(),this.updatePasteButtons()},getInfo:function(){return{hasData:!!this.data,storageMode:this.useSessionStorage?"Session":"Local",timestamp:this.data?this.data.timestamp:null,savedAt:this.data?this.data.savedAt:null,itemCount:this.data&&this.data.formData?Object.keys(this.data.formData).length:0}}},MBlockOnlineToggle={toggle:function(e,t){try{if(!t||!t.length)return console.warn("MBlock: Kein Item für Online/Offline Toggle gefunden"),!1;const e=!t.hasClass("mblock-offline"),o=t.find(".mblock-online-toggle"),n=o.find("i");return e?(t.addClass("mblock-offline"),o.removeClass("btn-online").addClass("btn-offline").attr("title","Set online"),n.length?n.removeClass("rex-icon-online").addClass("rex-icon-offline"):o.html('<i class="rex-icon rex-icon-offline"></i>'),this.setOfflineState(t,!0)):(t.removeClass("mblock-offline"),o.removeClass("btn-offline").addClass("btn-online").attr("title","Set offline"),n.length?n.removeClass("rex-icon-offline").addClass("rex-icon-online"):o.html('<i class="rex-icon rex-icon-online"></i>'),this.setOfflineState(t,!1)),!0}catch(e){return console.error("MBlock: Fehler beim Online/Offline Toggle:",e),!1}},setOfflineState:function(e,t){try{const o=e.find('input[name*="mblock_offline"]');o.length?o.val(t?"1":"0"):console.warn("MBlock: No mblock_offline input found - must be defined in template for this functionality")}catch(e){console.error("MBlock: Fehler beim Setzen des Offline-Status:",e)}},initializeStates:function(e){try{e.find("> div.sortitem").each(function(e){const t=$(this);t.attr("data-mblock_index");let o=t.find('input[name*="mblock_offline"]');o.length||(o=t.find('input[name*="_offline"]')),o.length||(o=t.find('input[value="1"][type="hidden"]'));const n=t.find(".mblock-online-toggle"),i=n.find("i");n.length&&(!o.length||"1"!==o.val()&&1!==o.val()?(t.removeClass("mblock-offline"),n.removeClass("btn-offline").addClass("btn-online").attr("title","Set offline"),i.length?i.removeClass("rex-icon-offline").addClass("rex-icon-online"):n.html('<i class="rex-icon rex-icon-online"></i>')):(t.addClass("mblock-offline"),n.removeClass("btn-online").addClass("btn-offline").attr("title","Set online"),i.length?i.removeClass("rex-icon-online").addClass("rex-icon-offline"):n.html('<i class="rex-icon rex-icon-offline"></i>')))})}catch(e){console.error("MBlock: Fehler beim Initialisieren der Online/Offline-States:",e)}},toggleAutoDetected:function(e,t,o){try{if(!(t&&t.length&&o&&o.length))return console.warn("MBlock: Kein Item oder Button für Auto-Detected Toggle gefunden"),!1;const e=!("1"===o.attr("data-offline")),n=t.find('input[name*="mblock_offline"]');if(!n.length)return console.warn("MBlock: No mblock_offline input field found in item"),!1;n.val(e?"1":"0");const i=e?"btn-danger":"btn-success",l=e?"rex-icon-offline":"rex-icon-online",c=e?"Set online":"Set offline",a=e?"Offline":"Online";o.removeClass("btn-default btn-warning btn-success btn-danger").addClass(i).attr("title",c).attr("data-offline",e?"1":"0");const r=o.find("i");r.length&&r.removeClass("rex-icon-online rex-icon-offline").addClass(l);const s=o.html().replace(/Offline|Online/,a);return o.html(s),e?t.addClass("mblock-offline"):t.removeClass("mblock-offline"),!0}catch(e){return console.error("MBlock: Fehler beim Auto-Detected Toggle:",e),!1}}};function mblock_init_toolbar(e){try{if(!checkCopyPasteEnabled())return;e.find(".mblock-copy-paste-toolbar .mblock-paste-btn").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.hasClass("disabled")||t.prop("disabled")||MBlockClipboard.paste(e,!1)}catch(e){console.error("MBlock: Fehler in toolbar paste click handler:",e)}return!1}),e.find(".mblock-copy-paste-toolbar .mblock-clear-clipboard").off("click.mblock").on("click.mblock",function(e){e.preventDefault();try{MBlockClipboard.clear()}catch(e){console.error("MBlock: Fehler in clear clipboard click handler:",e)}return!1})}catch(e){console.error("MBlock: Fehler in mblock_init_toolbar:",e)}}function mblock_moveup(e,t){var o=t.prev();0!=o.length&&setTimeout(function(){t.insertBefore(o),mblock_reindex(e),mblock_remove(e);let n=o;n.trigger("mblock:change",[n])},150)}function mblock_movedown(e,t){var o=t.next();0!=o.length&&setTimeout(function(){t.insertAfter(o),mblock_reindex(e),mblock_remove(e);let n=o;n.trigger("mblock:change",[n])},150)}function mblock_scroll(e,t){try{if(!(e&&e.length&&t&&t.length))return!1;const o=e.data();if(o&&o.hasOwnProperty("smooth_scroll")&&!0===o.smooth_scroll&&"function"==typeof $.mblockSmoothScroll)return $.mblockSmoothScroll({scrollTarget:t,speed:500}),!0;if(t.length&&t.offset()){const e=t.offset().top,o=$(window).height(),n=$(window).scrollTop();(e<n||e>n+o-200)&&$("html, body").animate({scrollTop:e-100},300)}return!0}catch(e){return console.error("MBlock: Fehler in mblock_scroll:",e),!1}}function mblock_add(e){try{if(!e||!e.length)return console.warn("MBlock: Ungültiges Element bei mblock_add"),!1;e.find("> div.sortitem .addme").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);if(!t.prop("disabled")){const o=t.parents(".sortitem").attr("data-mblock_index");o&&e.attr("data-mblock_clicked_add_item",o),mblock_add_item(e,t.closest('div[class^="sortitem"]'))}}catch(e){console.error("MBlock: Fehler in addme click handler:",e)}return!1}),e.find("> div.sortitem .removeme").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.prop("disabled")||mblock_remove_item(e,t.closest('div[class^="sortitem"]'))}catch(e){console.error("MBlock: Fehler in removeme click handler:",e)}return!1}),e.find("> div.sortitem .moveup").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.prop("disabled")||mblock_moveup(e,t.closest('div[class^="sortitem"]'))}catch(e){console.error("MBlock: Fehler in moveup click handler:",e)}return!1}),e.find("> div.sortitem .movedown").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);t.prop("disabled")||mblock_movedown(e,t.closest('div[class^="sortitem"]'))}catch(e){console.error("MBlock: Fehler in movedown click handler:",e)}return!1});const t=e.find("> div.sortitem .mblock-copy-btn");t.length>0&&checkCopyPasteEnabled()&&t.off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this).closest('div[class^="sortitem"]');MBlockClipboard.copy(e,t)}catch(e){console.error("MBlock: Fehler in copy click handler:",e)}return!1});const o=e.find("> div.sortitem .mblock-paste-btn");return o.length>0&&checkCopyPasteEnabled()&&o.off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this);if(!t.hasClass("disabled")&&!t.prop("disabled")){const o=t.closest('div[class^="sortitem"]');MBlockClipboard.paste(e,o)}}catch(e){console.error("MBlock: Fehler in paste click handler:",e)}return!1}),e.find("> div.sortitem .mblock-online-toggle").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this).closest('div[class^="sortitem"]');MBlockOnlineToggle.toggle(e,t)}catch(e){console.error("MBlock: Fehler in online/offline toggle handler:",e)}return!1}),e.find("> div.sortitem .mblock-offline-toggle-btn").off("click.mblock").on("click.mblock",function(t){t.preventDefault();try{const t=$(this),o=t.closest('div[class^="sortitem"]');MBlockOnlineToggle.toggleAutoDetected(e,o,t)}catch(e){console.error("MBlock: Fehler in auto-detected toggle handler:",e)}return!1}),checkCopyPasteEnabled()&&MBlockClipboard.updatePasteButtons(),MBlockOnlineToggle.initializeStates(e),!0}catch(e){return console.error("MBlock: Fehler in mblock_add:",e),!1}}function mblock_reinitialize_redaxo_widgets(e){try{if(!e||!e.length)return!1;const t=parseInt(e.attr("data-mblock_index"))||1,o=e.closest(".mblock_wrapper").find(".sortitem").length||1;return e.find('input[id^="REX_MEDIA_"]').each(function(){const e=$(this),t=e.attr("id");if(t){const o=e.closest(".rex-js-widget-media");o.length&&o.find(".btn-popup").each(function(){const e=$(this),o=e.attr("onclick");if(o){const n=t.match(/REX_MEDIA_(\d+)/);if(n){const t=n[1];if(o.includes("openREXMedia")){const n=o.replace(/openREXMedia\([^,)]+/,`openREXMedia('${t}'`);e.attr("onclick",n)}else if(o.includes("viewREXMedia")){const n=o.replace(/viewREXMedia\([^,)]+/,`viewREXMedia('${t}'`);e.attr("onclick",n)}else if(o.includes("deleteREXMedia")){const n=o.replace(/deleteREXMedia\([^)]+/,`deleteREXMedia('${t}'`);e.attr("onclick",n)}else if(o.includes("addREXMedia")){const n=o.replace(/addREXMedia\([^,)]+/,`addREXMedia('${t}'`);e.attr("onclick",n)}}}})}}),e.find('input[id^="REX_MEDIALIST_"], select[id^="REX_MEDIALIST_SELECT_"]').each(function(){const e=$(this),t=e.attr("id");if(t){const o=t.match(/REX_MEDIALIST_(?:SELECT_)?(\d+)/);if(o){const t=o[1],n=e.closest(".rex-js-widget-medialist");n.length&&n.find(".btn-popup").each(function(){const e=$(this),o=e.attr("onclick");if(o)if(o.includes("openREXMedialist")){const n=o.replace(/openREXMedialist\([^,)]+/,`openREXMedialist('${t}'`);e.attr("onclick",n)}else if(o.includes("viewREXMedialist")){const n=o.replace(/viewREXMedialist\([^,)]+/,`viewREXMedialist('${t}'`);e.attr("onclick",n)}else if(o.includes("addREXMedialist")){const n=o.replace(/addREXMedialist\([^,)]+/,`addREXMedialist('${t}'`);e.attr("onclick",n)}else if(o.includes("deleteREXMedialist")){const n=o.replace(/deleteREXMedialist\([^)]+/,`deleteREXMedialist('${t}'`);e.attr("onclick",n)}else if(o.includes("moveREXMedialist")){const n=o.replace(/moveREXMedialist\([^,)]+/,`moveREXMedialist('${t}'`);e.attr("onclick",n)}})}}}),e.find('input[id^="REX_LINK_"]').each(function(){const e=$(this),t=e.attr("id");if(t&&!t.includes("_NAME")){const o=t.match(/REX_LINK_(\d+)$/);if(o){const t=o[1],n=e.closest(".rex-js-widget-link, .rex-js-widget-customlink");n.length&&n.find(".btn-popup").each(function(){const e=$(this),o=e.attr("onclick");if(o)if(o.includes("openLinkMap")){const n=o.replace(/openLinkMap\([^,)]+/,`openLinkMap('REX_LINK_${t}'`);e.attr("onclick",n)}else if(o.includes("deleteREXLink")){const n=o.replace(/deleteREXLink\([^)]+/,`deleteREXLink('${t}'`);e.attr("onclick",n)}})}}}),e.find('input[id^="REX_LINKLIST_"], select[id^="REX_LINKLIST_SELECT_"]').each(function(){const e=$(this),t=e.attr("id");if(t){const o=t.match(/REX_LINKLIST_(?:SELECT_)?(\d+)/);if(o){const t=o[1],n=e.closest(".rex-js-widget-linklist");n.length&&n.find(".btn-popup").each(function(){const e=$(this),o=e.attr("onclick");if(o)if(o.includes("openREXLinklist")){const n=o.replace(/openREXLinklist\([^,)]+/,`openREXLinklist('${t}'`);e.attr("onclick",n)}else if(o.includes("deleteREXLinklist")){const n=o.replace(/deleteREXLinklist\([^)]+/,`deleteREXLinklist('${t}'`);e.attr("onclick",n)}else if(o.includes("moveREXLinklist")){const n=o.replace(/moveREXLinklist\([^,)]+/,`moveREXLinklist('${t}'`);e.attr("onclick",n)}})}}}),e.find('input[id^="REX_LINK_"]').each(function(){const n=$(this),i=n.attr("id");if(i&&!i.includes("_NAME")&&"hidden"===n.attr("type")){const l=i.match(/REX_LINK_(\d+)$/);if(l){const i=l[1],c=t+o+"00"+(n.index()||Math.floor(100*Math.random())),a="REX_LINK_"+c;n.attr("id",a);const r="REX_LINK_"+i+"_NAME",s="REX_LINK_"+c+"_NAME";let d=n.closest(".input-group, .form-group, .rex-widget").find("#"+r);d.length||(d=e.find("#"+r)),d.length||(d=$("#"+r)),d.length?(d.attr("id",s),console.log("MBlock: REX_LINK IDs aktualisiert:",r,"→",s)):console.warn("MBlock: Display Input nicht gefunden:",r);const f=n.closest(".rex-js-widget-link, .rex-js-widget-customlink, .input-group");f.length&&f.find(".btn-popup").each(function(){const e=$(this),t=e.attr("onclick");if(t)if(t.includes("openLinkMap")){const o=t.replace(/openLinkMap\([^,)]+/,`openLinkMap('REX_LINK_${c}'`);e.attr("onclick",o)}else if(t.includes("deleteREXLink")){const o=t.replace(/deleteREXLink\([^)]+/,`deleteREXLink('${c}'`);e.attr("onclick",o)}})}}}),"undefined"!=typeof mform_custom_link&&"function"==typeof customlink_init_widget&&e.find(".rex-js-widget-customlink .input-group.custom-link").each(function(){const e=$(this);if(!e.hasClass("init_custom_link_widget"))try{customlink_init_widget(e)}catch(e){console.warn("MBlock: Fehler bei MForm custom link Initialisierung:",e)}}),e.find("button[onclick], a[onclick]").each(function(){const e=$(this),t=e.attr("onclick");if(t&&(t.includes("REX_MEDIA")||t.includes("REX_LINK")))try{e.off("click.mblock-widget").on("click.mblock-widget",function(e){return!0})}catch(e){console.warn("MBlock: Fehler bei HTML onclick Reinitialisierung:",e)}}),e.find('input[name*="REX_MEDIA"], input[name*="REX_LINK"]').each(function(){const e=$(this),t=e.attr("name");if(!e.attr("id")&&t)if(t.includes("REX_MEDIA")){const o=e.attr("id");o&&o.startsWith("REX_MEDIA_")||console.warn("MBlock: Media input missing proper ID, trying to fix:",t)}else if(t.includes("REX_LINK")){const o=e.attr("id");o&&o.startsWith("REX_LINK_")||console.warn("MBlock: Link input missing proper ID, trying to fix:",t)}}),console.log("MBlock: REDAXO widgets reinitialized for new block"),window.MBlockClipboard&&window.MBlockClipboard.data&&window.MBlockClipboard.data.formData&&(setTimeout(()=>{const t=window.MBlockClipboard.data.formData;Object.keys(t).forEach(o=>{const n=t[o];n&&"rex_link_normal"===n.type&&n.displayText&&e.find('input[type="hidden"][id^="REX_LINK_"]').each(function(){const t=$(this);if(t.attr("name")===o&&t.val()===n.value){let o;if(n.isCorePowered&&n.nameFieldName)o=e.find('input[name="'+n.nameFieldName+'"]');else{const e=t.attr("id");o=$("#"+e+"_NAME")}!o||!o.length||o.val()&&""!==o.val()||(n.displayText?(o.val(n.displayText),console.log("MBlock: REX_LINK Display Text post-widget wiederhergestellt:",n.displayText,"für",o.attr("id")||o.attr("name"),n.isCorePowered?"(Core)":"(HTML)")):mblock_fetch_article_name(n.value,o))}})})},100),[200,500,1e3].forEach((t,o)=>{setTimeout(()=>{const t=window.MBlockClipboard.data.formData;Object.keys(t).forEach(n=>{const i=t[n];i&&"rex_link_normal"===i.type&&i.value&&e.find('input[type="hidden"][id^="REX_LINK_"]').each(function(){const t=$(this);if(t.attr("name")===n&&t.val()===i.value){let n;if(i.isCorePowered&&i.nameFieldName)n=e.find('input[name="'+i.nameFieldName+'"]');else{const e=t.attr("id");n=$("#"+e+"_NAME")}if(n&&n.length&&(!n.val()||""===n.val())){const e=i.displayText||window.mblock_article_cache?.[i.value]||"Artikel ["+i.value+"]";n.val(e),n.trigger("change"),console.log(`MBlock: AGGRESSIVER REX_LINK Fix (Versuch ${o+2}):`,e,"für",n.attr("id"))}}})})},t)})),!0}catch(e){return console.error("MBlock: Fehler bei der Reinitialisierung der REDAXO Widgets:",e),!1}}function mblock_smooth_scroll_to_element(e,t={}){if(!e)return;if("undefined"!=typeof BLOECKS&&"function"==typeof BLOECKS.scrollToSlice)try{return void BLOECKS.scrollToSlice(e)}catch(e){console.warn("MBlock: Bloecks scroll failed, using fallback:",e)}const o={behavior:"smooth",block:"center",inline:"nearest",offset:-20,...t};try{if("scrollIntoView"in e){const t=e.getBoundingClientRect().top+window.pageYOffset+o.offset;window.scrollTo({top:Math.max(0,t),behavior:o.behavior})}else e.scrollIntoView({behavior:o.behavior,block:o.block,inline:o.inline})}catch(t){try{e.scrollIntoView()}catch(e){console.warn("MBlock: Smooth scroll nicht verfügbar:",e)}}}function mblock_fetch_article_name(e,t){if(!e||!t||!t.length)return;if(window.mblock_article_cache||(window.mblock_article_cache={}),window.mblock_article_cache[e])return t.val(window.mblock_article_cache[e]),void console.log("MBlock: Artikel-Name aus Cache:",window.mblock_article_cache[e],"für ID:",e);const o=$('input[name="clang"]').val()||1,n=rex.backend+"?page=structure/linkmap&opener_input_field=temp&article_id="+e+"&clang="+o;$.ajax({url:n,method:"GET",timeout:5e3,success:function(o){let n="";const i=[/<a[^>]+onclick="[^"]*selectLink[^"]*"[^>]*>([^<]+)</gi,/<span[^>]*class="[^"]*article[^"]*"[^>]*>([^<]+)</gi,/article_name['"]*:\s*['"]([^'"]+)['"]/gi,/"name"\s*:\s*"([^"]+)"/gi];for(const e of i){const t=e.exec(o);if(t&&t[1]&&t[1].trim()){n=t[1].trim();break}}n||(n="Artikel ["+e+"]"),window.mblock_article_cache[e]=n,t.val(n),t.trigger("change"),console.log("MBlock: Artikel-Name per AJAX geholt:",n,"für ID:",e)},error:function(){const o="Artikel ["+e+"]";window.mblock_article_cache[e]=o,t.val(o),console.log("MBlock: Artikel-Name Fallback verwendet:",o,"für ID:",e)}})}function mblock_initialize_empty_rex_link_fields(){try{console.log("MBlock: Initialisiere leere REX_LINK Display-Felder...");let e=0,t=0;$('input[id^="REX_LINK_"]').each(function(){const o=$(this),n=o.attr("id"),i=o.val();if(e++,console.log("MBlock: Prüfe REX_LINK Feld:",n,"Wert:",i,"Typ:",o.attr("type")),n&&!n.includes("_NAME")&&"hidden"===o.attr("type")&&i&&""!==i.trim()){const e=n+"_NAME",o=$("#"+e);if(console.log("MBlock: Suche Display-Feld:",e,"gefunden:",o.length,"aktueller Wert:",o.val()),o.length){const n=o.val()||"";""===n.trim()?(console.log("MBlock: Befülle leeres REX_LINK Display-Feld:",e,"für Artikel:",i),mblock_fetch_article_name(i,o),t++):console.log("MBlock: Display-Feld bereits befüllt:",e,"Wert:",n)}else console.warn("MBlock: Display-Feld nicht gefunden:",e,"(möglicherweise in verstecktem Tab)")}}),console.log("MBlock: REX_LINK Initialisierung abgeschlossen. Gefunden:",e,"Verarbeitet:",t),$('.tab-pane.active input[id^="REX_LINK_"], .tab-content .active input[id^="REX_LINK_"]').each(function(){const e=$(this),t=e.attr("id"),o=e.val();if(t&&!t.includes("_NAME")&&"hidden"===e.attr("type")&&o&&""!==o.trim()){const e=t+"_NAME",n=$("#"+e);!n.length||n.val()&&""!==n.val().trim()||(console.log("MBlock: Befülle REX_LINK in aktivem Tab:",e),mblock_fetch_article_name(o,n))}})}catch(e){console.error("MBlock: Fehler beim Initialisieren der REX_LINK Display-Felder:",e)}}$(document).ready(function(){setTimeout(function(){mblock_initialize_empty_rex_link_fields()},500),$(document).on("shown.bs.tab",function(e){setTimeout(function(){console.log("MBlock: Bootstrap Tab gewechselt - initialisiere REX_LINK-Felder..."),mblock_initialize_empty_rex_link_fields()},100)}),$(document).on("click",'.nav-tabs a, .nav-pills a, [data-toggle="tab"], [data-bs-toggle="tab"], .mform-tabs a',function(){setTimeout(function(){console.log("MBlock: Tab-Click erkannt - initialisiere REX_LINK-Felder..."),mblock_initialize_empty_rex_link_fields()},200)}),$(document).on("mform:tabChanged mform:tabShow",function(e){setTimeout(function(){console.log("MBlock: MForm Tab-Event - initialisiere REX_LINK-Felder..."),mblock_initialize_empty_rex_link_fields()},150)})});